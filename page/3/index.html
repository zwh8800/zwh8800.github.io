<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 3 页 | wastecat的博客</title>

  
  <meta name="author" content="wastecat">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="wastecat的博客"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="wastecat的博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 4.2.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">wastecat的博客</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/2020/04/29/hello-world/">关于</a></li>
      
        <li><a href="/atom.xml">订阅</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    
  <article>

  
    
    <h3 class="article-title"><a href="/2016/04/29/最近读的几本书/"><span>最近读的几本书</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/04/29/最近读的几本书/" rel="bookmark">
        <time class="entry-date published" datetime="2016-04-29T07:05:14.000Z">
          2016-04-29
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>上月做了个决定，上下班地铁上只看书不玩手机。今天回首一看，已经读了 6 本了。所以说把一件<strong>微小的事情</strong>坚持下来，它就不微小了。这几天看的书类目很杂，有技术的，有天文的，还有科普的。先把书单列一下，然后简单写个短评。</p>
<p><a href="/notename/" title="book review 1"></a></p>
<center>
![D6D0015D8454E99C7DB8AD66A4B33974.jpg-2072.9kB][1]
</center>

<p>最近看的书单如下，挨个写个短评吧。</p>
<ul>
<li>《微服务架构与实现》</li>
<li>《夜观星空：天文观测实践指南》</li>
<li>《七周七并发模型》</li>
<li>《时间简史》</li>
<li>《果壳中的宇宙》</li>
<li>《通俗天文学：和大师一起与宇宙对话》</li>
</ul>
<h2 id="微服务架构与实现"><a href="#微服务架构与实现" class="headerlink" title="微服务架构与实现"></a>微服务架构与实现</h2><p>讲的比较泛泛，不过里面讲解微服务的优点和解决的问题这部分还是比较不错的。如果可以用一个具体的实践来讲解就更好了。看完这本书之后，想去具体实践一下微服务，但是中途遇到很多细节的问题，不知道怎样做才算是最佳实践。</p>
<h2 id="夜观星空：天文观测实践指南"><a href="#夜观星空：天文观测实践指南" class="headerlink" title="夜观星空：天文观测实践指南"></a>夜观星空：天文观测实践指南</h2><p>很不错，从实践角度讲解了如何观测星座、行星、月亮、太阳。讲解了很多新手 “后院天文学家” 不知道的小技巧。利用这些小技巧可以很快入门天文学，建立对星空的兴趣与热爱。不过不足之处也很明显，太过注重实践，很多天文学的理论知识没有讲解（术语，计算方式）。导致想要深一步理解原理需要自己 wiki 。</p>
<h2 id="七周七并发模型"><a href="#七周七并发模型" class="headerlink" title="七周七并发模型"></a>七周七并发模型</h2><p>超赞的一本书，干货很翔实。除了第一章的《线程与锁》以外，其他章讲解的内容都是我不熟悉的并发开发方式。讲解了各种并发模型解决的问题，以及实现方式。5星推荐。</p>
<h2 id="时间简史"><a href="#时间简史" class="headerlink" title="时间简史"></a>时间简史</h2><p>科普书籍吧，缺点很明显，没有公式。有时候讲解一个理论不是单靠图片和文字就能让人理解的。很多时候，使用比喻可能会让人理解起来更加迷茫。如果能对空间弯曲的理论进行一下数学推导就好了，真的好想了解一下黎曼数学的理论。不知道有没有其他什么比较好的科普书籍讲这部分的，最好能以通俗易懂的方式讲一下相对论的推导过程。</p>
<h2 id="果壳中的宇宙"><a href="#果壳中的宇宙" class="headerlink" title="果壳中的宇宙"></a>果壳中的宇宙</h2><p>和上一本差不多吧，讲故事有些多。真正的干货看不到。毛病还是一样，不恰当的比喻让人更佳费解。</p>
<h2 id="通俗天文学：和大师一起与宇宙对话"><a href="#通俗天文学：和大师一起与宇宙对话" class="headerlink" title="通俗天文学：和大师一起与宇宙对话"></a>通俗天文学：和大师一起与宇宙对话</h2><p>很好，首先是讲解了天文学的基础理论。天球坐标系统、天体运动的表现。之后挨个讲解太阳系的各个天体。理论和实践兼顾，不错。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/闲扯/">闲扯</a><a href="/tags/书评/">书评</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/04/29/最近读的几本书/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/04/27/在OSX的命令行下使用代理/"><span>在 OS X 的命令行下使用代理</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/04/27/在OSX的命令行下使用代理/" rel="bookmark">
        <time class="entry-date published" datetime="2016-04-27T03:39:43.000Z">
          2016-04-27
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>相信程序员们工作中必不可少的就是一个趁手的代理。但是 Mac 客户端只提供了系统代理（供 app 调用的）和一个裸的 socks5 代理。都不方便在命令行工具中使用。下面介绍一种方法可以方便的在命令行中使用代理的方法。</p>
<p><a href="/notename/" title="using proxy in osx terminal"></a></p>
<p>首先介绍一个常识，大多数 gnu unix 程序都会访问一个环境变量 <code>http_proxy</code> ，比如 curl 在执行时会先访问一下 http_proxy ， 如果有这个变量的话，会使用这个变量给出的地址作为 proxy 。这相当于是 gnu 给我们带来的一个福利<a href="具体参考[这里](https://wiki.archlinux.org/index.php/proxy_settings)">^proxysetting</a>。</p>
<p>但是这个方式只支持 http、https、ftp 和 rsync 协议，不过大多数情况下也够用了，因为在命令行下大多是执行 <code>npm</code>，<code>go get</code> 才会用到代理，而这些程序打多使用 http 协议。</p>
<p>那么，具体思路就是使用一个转换器，把 socks5 代理转换成 http 代理，然后使用 <code>http_proxy</code> 环境变量。</p>
<p>polipo 可以做代理转换器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装polipo</span></span><br><span class="line">brew install polipo</span><br></pre></td></tr></table></figure>

<p>为了方便我们使用它，可以在 <code>~/.bash_profile</code> 里加一个 alias：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ~/.bash_profile</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">alias</span> startPolipo=<span class="string">'polipo socksParentProxy=localhost:1080 proxyAddress=0.0.0.0'</span></span><br></pre></td></tr></table></figure>

<p>这样，在使用之前，需要先开一个新的 term 窗口，执行一下 <code>startPolipo</code> 开启一个代理转换器。可以看到 polipo 监听了 8123 端口。</p>
<p>之后，在需要代理的程序前面加上 <code>http_proxy=http://localhost:8123 https_proxy=http://localhost:8123</code> 就可以让程序使用代理了。</p>
<p>另外，为了更加方便，我们可以再搞一个 alise：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> proxy=<span class="string">'env http_proxy=http://localhost:8123 https_proxy=http://localhost:8123'</span></span><br></pre></td></tr></table></figure>

<p>只需要每次在需要使用 proxy 的命令前面加上 <code>proxy</code> 就可以使用代理了。例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy curl https://google.com/</span><br></pre></td></tr></table></figure>

<p>可以看见 curl 打印了 Google 首页出来</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/bash/">bash</a><a href="/tags/mac技巧/">mac技巧</a><a href="/tags/terminal/">terminal</a><a href="/tags/代理/">代理</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/04/27/在OSX的命令行下使用代理/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/04/20/await-async深度剖析/"><span>await &amp; async 深度剖析</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/04/20/await-async深度剖析/" rel="bookmark">
        <time class="entry-date published" datetime="2016-04-20T04:54:20.000Z">
          2016-04-20
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>await 语法最早被引入到流行语言是 c# 5.0 ，微软在 c# 中添加了 <code>await &amp; async</code> 关键字和一系列配套 API ，引起了开发者的一致好评。await 可以极大的简化异步编程，而使用异步编程最多的就是 javascript 了。所以开发者们也迫不及待的向 javascript 中加入 await 关键字。目前此特性已经在 babel 中比较完美的实现了。而 await 特性也被加入了 <code>stage-3</code> （Candidate），不过貌似是赶不上今年的 ES2016 了，估计最晚会在 ES2017 中被正式加入 javascript 。那么本文就来深度剖析一下 <code>await &amp; async</code> 的用法、好处以及实现方式。</p>
<p><a href="/notename/" title="in depth analysis of await and async"></a></p>
<p>[toc]</p>
<h2 id="异步？同步？"><a href="#异步？同步？" class="headerlink" title="异步？同步？"></a>异步？同步？</h2><p>异步编程模型对于 IO 密集型的任务具有得天独厚的优势。这里用一个例子来解释。</p>
<p>假如我们需要做一个爬虫，爬到的东西有两种，一种是索引页，一种是内容页。大概需要以下几步：</p>
<ul>
<li>使用 http 请求一个索引页，从这个从索引中取出所有的 URL</li>
<li>分别请求所有的 URL</li>
<li>如果请求到的还是 <strong>索引页</strong> 那么递归这个操作（回到步骤 1 ）</li>
<li>如果是 <strong>内容页</strong> ，那么我们对内容页做一些处理</li>
<li>最后，把处理后的保存到数据库</li>
</ul>
<p>那么，分别使用原生支持异步编程的 NodeJS 和原生不支持异步编程 golang 的语言实现这个爬虫。分别使用两种语言 <strong>最常见</strong> 的实现方式。</p>
<blockquote>
<p><small>因为发 http 请求和保存数据库还需要一些额外代码，会干扰视线，所以例子代码是递归的读一个文件夹，并把所有 html 文件做一些修改，然后保存到源文件。但是原理上和爬虫是相通的。</small></p>
</blockquote>
<h3 id="golang-实现爬虫"><a href="#golang-实现爬虫" class="headerlink" title="golang 实现爬虫"></a>golang 实现爬虫</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"io/ioutil"</span></span><br><span class="line">  <span class="string">"log"</span></span><br><span class="line">  <span class="string">"path"</span></span><br><span class="line">  <span class="string">"path/filepath"</span></span><br><span class="line">  <span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> extname = <span class="string">".html"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> counter = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleDir</span><span class="params">(dir <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">  <span class="comment">// 读取文件夹列表</span></span><br><span class="line">  files, err := ioutil.ReadDir(dir)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Println(<span class="string">"error occurs when readDir"</span>, dir, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// iterate 文件列表</span></span><br><span class="line">  <span class="keyword">for</span> _, file := <span class="keyword">range</span> files &#123;</span><br><span class="line">    fullFilename := path.Join(dir, file.Name())</span><br><span class="line">    <span class="comment">// 判断文件类型</span></span><br><span class="line">    <span class="keyword">if</span> !file.IsDir() &amp;&amp; filepath.Ext(file.Name()) == extname &#123;</span><br><span class="line">      counter++</span><br><span class="line">      thisCount := counter</span><br><span class="line">      <span class="comment">// 打开始 log</span></span><br><span class="line">      log.Println(<span class="string">"start processing"</span>, fullFilename, </span><br><span class="line">        <span class="string">"["</span>, thisCount, <span class="string">"]"</span>)</span><br><span class="line">        </span><br><span class="line">      <span class="comment">// 读取文件</span></span><br><span class="line">      fileData, err := ioutil.ReadFile(fullFilename)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Println(<span class="string">"error occurs when processing"</span>, </span><br><span class="line">          fullFilename, err)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 做一些处理</span></span><br><span class="line">      fileString := <span class="keyword">string</span>(fileData)</span><br><span class="line">      fileString = strings.Replace(fileString, </span><br><span class="line">        <span class="string">"http://"</span>, <span class="string">"https://"</span>, <span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 保存文件</span></span><br><span class="line">      <span class="keyword">if</span> err := ioutil.WriteFile(fullFilename, </span><br><span class="line">          []<span class="keyword">byte</span>(fileString), <span class="number">0644</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Println(<span class="string">"error occurs when processing"</span>, </span><br><span class="line">          fullFilename, err)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 打结束 log</span></span><br><span class="line">      log.Println(<span class="string">"finish processing"</span>, fullFilename, </span><br><span class="line">        <span class="string">"["</span>, thisCount, <span class="string">"]"</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> file.IsDir() &#123;</span><br><span class="line">      <span class="comment">// 文件夹的话递归</span></span><br><span class="line">      handleDir(fullFilename)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  handleDir(<span class="string">"/Users/zzz/hzzz.lengzzz.com/"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="NodeJS-实现爬虫"><a href="#NodeJS-实现爬虫" class="headerlink" title="NodeJS 实现爬虫"></a>NodeJS 实现爬虫</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">'fs'</span>;</span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> counter = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> extname = <span class="string">'.html'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleDir</span>(<span class="params">dir</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 读取文件夹列表</span></span><br><span class="line">  fs.readdir(dir, <span class="function"><span class="keyword">function</span> (<span class="params">err, files</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// iterate 文件列表</span></span><br><span class="line">    files.map(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> fullFilename = path.join(dir, file);</span><br><span class="line">      fs.stat(fullFilename, <span class="function"><span class="keyword">function</span> (<span class="params">err, stats</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          <span class="built_in">console</span>.error(<span class="string">"error occurs when processing"</span>, file, err);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 判断文件类型</span></span><br><span class="line">        <span class="keyword">if</span> (stats.isFile() &amp;&amp; path.extname(file) == extname) &#123;</span><br><span class="line">          <span class="keyword">let</span> thisCount = counter++;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 打开始 log</span></span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'start processing'</span>, fullFilename, </span><br><span class="line">            <span class="string">'['</span>, thisCount, <span class="string">']'</span>);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 读取文件</span></span><br><span class="line">          fs.readFile(fullFilename, <span class="string">'utf-8'</span>, </span><br><span class="line">            <span class="function"><span class="keyword">function</span> (<span class="params">err, fileString</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">              <span class="built_in">console</span>.error(<span class="string">"error occurs when processing"</span>, </span><br><span class="line">                file, err);</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 做一些处理</span></span><br><span class="line">            fileString = fileString.replace(</span><br><span class="line">              /http:\/\<span class="comment">//g, 'https://');</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 写入文件</span></span><br><span class="line">            fs.writeFile(fullFilename, fileString, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">              <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="built_in">console</span>.error(<span class="string">"error occurs when processing"</span>, </span><br><span class="line">                  file, err);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="comment">// 打结束 log</span></span><br><span class="line">              <span class="built_in">console</span>.log(<span class="string">'finish processing'</span>, fullFilename, </span><br><span class="line">                <span class="string">'['</span>, thisCount, <span class="string">']'</span>);</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (stats.isDirectory()) &#123;</span><br><span class="line">          handleDir(fullFilename);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  handleDir(<span class="string">'/Users/zzz/hzzz.lengzzz.com/'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main();</span><br></pre></td></tr></table></figure>

<h3 id="公平起见-使用-goroutine-实现"><a href="#公平起见-使用-goroutine-实现" class="headerlink" title="公平起见 使用 goroutine 实现"></a>公平起见 使用 goroutine 实现</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"io/ioutil"</span></span><br><span class="line">  <span class="string">"log"</span></span><br><span class="line">  <span class="string">"path"</span></span><br><span class="line">  <span class="string">"path/filepath"</span></span><br><span class="line">  <span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> channelBuffer = <span class="number">50</span></span><br><span class="line"><span class="keyword">const</span> workerCount = <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> payload <span class="keyword">struct</span> &#123;</span><br><span class="line">  thisCount    <span class="keyword">int</span></span><br><span class="line">  fullFilename <span class="keyword">string</span></span><br><span class="line">  fileString   <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> producerToRead <span class="keyword">chan</span> *payload</span><br><span class="line"><span class="keyword">var</span> readToReplace <span class="keyword">chan</span> *payload</span><br><span class="line"><span class="keyword">var</span> replaceToWrite <span class="keyword">chan</span> *payload</span><br><span class="line"><span class="keyword">var</span> writeToComplete <span class="keyword">chan</span> *payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">  producerToRead = <span class="built_in">make</span>(<span class="keyword">chan</span> *payload, channelBuffer)</span><br><span class="line">  readToReplace = <span class="built_in">make</span>(<span class="keyword">chan</span> *payload, channelBuffer)</span><br><span class="line">  replaceToWrite = <span class="built_in">make</span>(<span class="keyword">chan</span> *payload, channelBuffer)</span><br><span class="line">  writeToComplete = <span class="built_in">make</span>(<span class="keyword">chan</span> *payload, channelBuffer)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reader</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> data := <span class="keyword">range</span> producerToRead &#123;</span><br><span class="line">    fileData, err := ioutil.ReadFile(data.fullFilename)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      log.Println(<span class="string">"error occurs when processing"</span>, </span><br><span class="line">        data.fullFilename, err)</span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line">    data.fileString = <span class="keyword">string</span>(fileData)</span><br><span class="line"></span><br><span class="line">    readToReplace &lt;- data</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">replacer</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> data := <span class="keyword">range</span> readToReplace &#123;</span><br><span class="line">    data.fileString = strings.Replace(data.fileString, </span><br><span class="line">      <span class="string">"http://"</span>, <span class="string">"https://"</span>, <span class="number">-1</span>)</span><br><span class="line">    replaceToWrite &lt;- data</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">writeer</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> data := <span class="keyword">range</span> replaceToWrite &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err := ioutil.WriteFile(data.fullFilename, </span><br><span class="line">      []<span class="keyword">byte</span>(data.fileString), <span class="number">0644</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      log.Println(<span class="string">"error occurs when processing"</span>, </span><br><span class="line">        data.fullFilename, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    writeToComplete &lt;- data</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">complete</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> data := <span class="keyword">range</span> writeToComplete &#123;</span><br><span class="line">    log.Println(<span class="string">"finish processing"</span>, data.fullFilename, </span><br><span class="line">      <span class="string">"["</span>, data.thisCount, <span class="string">"]"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> counter = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">producer</span><span class="params">(dir <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">const</span> extname = <span class="string">".html"</span></span><br><span class="line"></span><br><span class="line">  files, err := ioutil.ReadDir(dir)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Println(<span class="string">"error occurs when readDir"</span>, dir, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> _, file := <span class="keyword">range</span> files &#123;</span><br><span class="line">    fullFilename := path.Join(dir, file.Name())</span><br><span class="line">    <span class="keyword">if</span> !file.IsDir() &amp;&amp; filepath.Ext(file.Name()) == extname &#123;</span><br><span class="line">      counter++</span><br><span class="line">      thisCount := counter</span><br><span class="line">      log.Println(<span class="string">"start processing"</span>, fullFilename, </span><br><span class="line">        <span class="string">"["</span>, thisCount, <span class="string">"]"</span>)</span><br><span class="line"></span><br><span class="line">      producerToRead &lt;- &amp;payload&#123;</span><br><span class="line">        thisCount,</span><br><span class="line">        fullFilename,</span><br><span class="line">        <span class="string">""</span>,</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> file.IsDir() &#123;</span><br><span class="line">      producer(fullFilename)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 搞四个 worker</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startWorker</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; workerCount; i++ &#123;</span><br><span class="line">    <span class="keyword">go</span> reader()</span><br><span class="line">    <span class="keyword">go</span> replacer()</span><br><span class="line">    <span class="keyword">go</span> writeer()</span><br><span class="line">    <span class="keyword">go</span> complete()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  startWorker()</span><br><span class="line">  producer(<span class="string">"/Users/zzz/hzzz.lengzzz.com/"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Title: golang worker 实现</span><br><span class="line"></span><br><span class="line">Note over producer: 生成文件名</span><br><span class="line">producer-&gt;reader: channel</span><br><span class="line">Note over reader: 读文件</span><br><span class="line">reader-&gt;replacer: channel</span><br><span class="line">Note over replacer: 修改文件</span><br><span class="line">replacer-&gt;writer: channel</span><br><span class="line">Note over writer: 写文件</span><br><span class="line">writer-&gt;complete: channel</span><br><span class="line">Note over complete: 打 log</span><br><span class="line"></span><br><span class="line">Note over producer,complete: 并发</span><br></pre></td></tr></table></figure>

<h3 id="性能比较"><a href="#性能比较" class="headerlink" title="性能比较"></a>性能比较</h3><p>分别看一下两个程序打出的 log ，来分析一下哪个程序会运行的更快。</p>
<h4 id="golang-的-log"><a href="#golang-的-log" class="headerlink" title="golang 的 log"></a>golang 的 log</h4><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">start processing /<span class="number">1001</span>/index.html [ <span class="number">1</span> ]</span><br><span class="line">finish processing /<span class="number">1001</span>/index.html [ <span class="number">1</span> ]</span><br><span class="line">start processing /<span class="number">1001</span>/trackback/index.html [ <span class="number">2</span> ]</span><br><span class="line">finish processing /<span class="number">1001</span>/trackback/index.html [ <span class="number">2</span> ]</span><br><span class="line">start processing /<span class="number">1006</span>/index.html [ <span class="number">3</span> ]</span><br><span class="line">finish processing /<span class="number">1006</span>/index.html [ <span class="number">3</span> ]</span><br><span class="line">start processing /<span class="number">1006</span>/trackback/index.html [ <span class="number">4</span> ]</span><br><span class="line">finish processing /<span class="number">1006</span>/trackback/index.html [ <span class="number">4</span> ]</span><br><span class="line">start processing /<span class="number">101</span>/index.html [ <span class="number">5</span> ]</span><br><span class="line">finish processing /<span class="number">101</span>/index.html [ <span class="number">5</span> ]</span><br><span class="line">start processing /<span class="number">101</span>/trackback/index.html [ <span class="number">6</span> ]</span><br><span class="line">finish processing /<span class="number">101</span>/trackback/index.html [ <span class="number">6</span> ]</span><br><span class="line">start processing /<span class="number">1010</span>/index.html [ <span class="number">7</span> ]</span><br><span class="line">finish processing /<span class="number">1010</span>/index.html [ <span class="number">7</span> ]</span><br><span class="line">start processing /<span class="number">1010</span>/trackback/index.html [ <span class="number">8</span> ]</span><br><span class="line">finish processing /<span class="number">1010</span>/trackback/index.html [ <span class="number">8</span> ]</span><br><span class="line">start processing /<span class="number">1027</span>/index.html [ <span class="number">9</span> ]</span><br><span class="line">finish processing /<span class="number">1027</span>/index.html [ <span class="number">9</span> ]</span><br><span class="line">start processing /<span class="number">1027</span>/trackback/index.html [ <span class="number">10</span> ]</span><br><span class="line">finish processing /<span class="number">1027</span>/trackback/index.html [ <span class="number">10</span> ]</span><br></pre></td></tr></table></figure>

<p>特点是挨个抓取，第一个没有抓完不开始抓第二个。</p>
<h4 id="NodeJS-的-log"><a href="#NodeJS-的-log" class="headerlink" title="NodeJS 的 log"></a>NodeJS 的 log</h4><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">start processing /index.html [ <span class="number">0</span> ]</span><br><span class="line">start processing /blog/index.html [ <span class="number">1</span> ]</span><br><span class="line">start processing /blog/wp-login.html [ <span class="number">2</span> ]</span><br><span class="line">start processing /blog/<span class="number">1001</span>/index.html [ <span class="number">3</span> ]</span><br><span class="line">start processing /blog/<span class="number">1006</span>/index.html [ <span class="number">4</span> ]</span><br><span class="line">start processing /blog/<span class="number">101</span>/index.html [ <span class="number">5</span> ]</span><br><span class="line"></span><br><span class="line">... 省略</span><br><span class="line"></span><br><span class="line">start processing /blog/page/<span class="number">9</span>/index.html [ <span class="number">736</span> ]</span><br><span class="line">finish processing /index.html [ <span class="number">0</span> ]</span><br><span class="line">start processing /blog/date/<span class="number">2013</span>/<span class="number">08</span>/index.html [ <span class="number">737</span> ]</span><br></pre></td></tr></table></figure>

<p>特点是同时抓取网页，谁先抓完先处理谁，谁先处理完谁就保存。不需要等待。</p>
<h4 id="golang-第二版的-log"><a href="#golang-第二版的-log" class="headerlink" title="golang 第二版的 log"></a>golang 第二版的 log</h4><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">start processing /blog/<span class="number">1001</span>/index.html [ <span class="number">1</span> ]</span><br><span class="line">start processing /blog/<span class="number">1001</span>/trackback/index.html [ <span class="number">2</span> ]</span><br><span class="line">start processing /blog/<span class="number">1006</span>/index.html [ <span class="number">3</span> ]</span><br><span class="line">start processing /blog/<span class="number">1006</span>/trackback/index.html [ <span class="number">4</span> ]</span><br><span class="line">start processing /blog/<span class="number">101</span>/index.html [ <span class="number">5</span> ]</span><br><span class="line">start processing /blog/<span class="number">101</span>/trackback/index.html [ <span class="number">6</span> ]</span><br><span class="line">start processing /blog/<span class="number">1010</span>/index.html [ <span class="number">7</span> ]</span><br><span class="line">start processing /blog/<span class="number">1010</span>/trackback/index.html [ <span class="number">8</span> ]</span><br><span class="line">start processing /blog/<span class="number">1027</span>/index.html [ <span class="number">9</span> ]</span><br><span class="line">start processing /blog/<span class="number">1027</span>/trackback/index.html [ <span class="number">10</span> ]</span><br><span class="line">start processing /blog/<span class="number">1030</span>/index.html [ <span class="number">11</span> ]</span><br><span class="line">start processing /blog/<span class="number">1030</span>/trackback/index.html [ <span class="number">12</span> ]</span><br><span class="line">start processing /blog/<span class="number">1038</span>/index.html [ <span class="number">13</span> ]</span><br><span class="line">start processing /blog/<span class="number">1038</span>/trackback/index.html [ <span class="number">14</span> ]</span><br><span class="line">finish processing /blog/<span class="number">101</span>/trackback/index.html [ <span class="number">6</span> ]</span><br><span class="line">start processing /blog/<span class="number">1040</span>/index.html [ <span class="number">15</span> ]</span><br></pre></td></tr></table></figure>

<h4 id="KFC-和-麻辣烫"><a href="#KFC-和-麻辣烫" class="headerlink" title="KFC 和 麻辣烫"></a>KFC 和 麻辣烫</h4><p>可以对比一下 KFC 和 麻辣烫 店的点餐方式，和上面两个程序有异曲同工之妙。</p>
<ul>
<li>KFC：大家排队，前面的餐没全部做出来前不服务下一个客户</li>
<li>麻辣烫：大家分别点餐，然后拿个号码，叫号取餐</li>
</ul>
<p>谁更快显而易见。在 KFC 里最怕前面点个全家桶，好不容易排到第一个了，结果还不如旁边队列里最后的取餐快。</p>
<p>所以可见，NodeJS 只需要使用一般的写法就能自动获得 <strong>性能加成</strong> 还是很有吸引力的。</p>
<h3 id="可读性比较"><a href="#可读性比较" class="headerlink" title="可读性比较"></a>可读性比较</h3><p>golang 的代码是按照先后顺序很直观的顺下来的，可以看一下几个注释，都在同一个缩进级别。</p>
<p>而 NodeJS 使用了大量回调函数，本身串行的逻辑看起来却像是内嵌的感觉，从代码的缩进就能明显的看出来。大家亲切的成这种代码风格叫做 <strong>冲击波</strong>。</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 冲击波</span></span><br><span class="line">&#123;</span><br><span class="line">  &#123;</span><br><span class="line">    &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        &#123;</span><br><span class="line">          &#123;</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">// ============ &gt;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>golang 使用 goroutine 重新实现之后性能得到了提升，但是可读性也是降低了一些。如果逻辑比较复杂则 channel 不很好设计。</p>
<p>除此之外 NodeJS 的写法还有几个坑：</p>
<ul>
<li>对循环支持的不好，循环内部的回调函数访问同一个闭包变量（ES2015 的 <code>let</code> 可解决这个问题） </li>
<li>错误处理不友好，只能（ almostly ）直接跳出事务，没法爽快 try catch （例子：超时重传）</li>
</ul>
<h2 id="同步的代码-异步的事情"><a href="#同步的代码-异步的事情" class="headerlink" title="同步的代码 异步的事情"></a>同步的代码 异步的事情</h2><p>那么有没有一种方法，能同时具备两种写法的优点呢？答案就是前端终极武器 <code>await &amp; async</code> 。</p>
<p>首先来看一下 <code>await</code> 的使用方法，我给出一个同样功能（爬虫）的示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; readDir, stat, readFile, writeFile &#125; <span class="keyword">from</span> <span class="string">'./api_promise'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> counter = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> extname = <span class="string">'.html'</span>;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">handleDir</span>(<span class="params">dir</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 读取文件夹列表</span></span><br><span class="line">    <span class="keyword">let</span> files = <span class="keyword">await</span> readDir(dir);</span><br><span class="line">    <span class="comment">// iterate 列表</span></span><br><span class="line">    files.map(<span class="keyword">async</span> file =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> fullFilename = path.join(dir, file);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 检查文件类型</span></span><br><span class="line">        <span class="keyword">let</span> stats = <span class="keyword">await</span> stat(fullFilename);</span><br><span class="line">        <span class="keyword">if</span> (stats.isFile() &amp;&amp; path.extname(file) == extname) &#123;</span><br><span class="line">          <span class="keyword">let</span> thisCount = counter++;</span><br><span class="line">          <span class="comment">// 打开始 log</span></span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'start processing'</span>, fullFilename, </span><br><span class="line">            <span class="string">'['</span>, thisCount, <span class="string">']'</span>);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 读文件</span></span><br><span class="line">          <span class="keyword">let</span> fileString = <span class="keyword">await</span> readFile(fullFilename, <span class="string">'utf-8'</span>);</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 改文件</span></span><br><span class="line">          fileString = fileString.replace(<span class="regexp">/http:\/\//g</span>, <span class="string">'https://'</span>);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 写文件</span></span><br><span class="line">          <span class="keyword">await</span> writeFile(fullFilename, fileString);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 打结束 log</span></span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'finish processing'</span>, fullFilename, </span><br><span class="line">            <span class="string">'['</span>, thisCount, <span class="string">']'</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (stats.isDirectory()) &#123;</span><br><span class="line">          handleDir(fullFilename);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">"error occurs when processing"</span>, file, err);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">"error occurs when readDir"</span>, dir, err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  handleDir(<span class="string">'/Users/zzz/hzzz.lengzzz.com/'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main();</span><br></pre></td></tr></table></figure>

<p>代码清晰了不少，但是性能还和之前一样，异步的读文件，异步的写文件。另外我还加入了 <code>try catch</code> ，来演示 await 对 try catch 的支持。</p>
<p>此外，还需要做的事情是对原生的 API 进行一下包装。使之返回一个 <code>Promise</code> 以支持 await。</p>
<p>如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">"fs"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">readDir</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    fs.readdir(path, <span class="function"><span class="keyword">function</span> (<span class="params">err, files</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        reject(err);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      resolve(files);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里只举例一个了，这个文件 wrap 了四个 NodeJS API ，都是使用相同的方式包装的。</p>
<h2 id="实现篇"><a href="#实现篇" class="headerlink" title="实现篇"></a>实现篇</h2><p>其实，await 只是一个语法糖。下面，分析一下这颗糖底层是怎么实现的。</p>
<h3 id="Iterator"><a href="#Iterator" class="headerlink" title="Iterator"></a>Iterator</h3><p>要说 await 不得不先温习一些前置知识，比如 iterator 和协程。</p>
<p>在大部分语言中，要实现一个类型可以被 iterate （既让一个类型 iterable）一般需要实现一个叫 <code>Iterable</code> 的 interface。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">List</span> <span class="keyword">implements</span> <span class="title">Iterable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个 Iterable 有方法能返回一个 <code>Iterator</code> 循环调用 Iterator 的方法 <code>next()</code> 可以得到下一个元素，调用 <code>hasNext()</code> 可以判断是否结束。</p>
<p>所以 Iterator 可以这样实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">List</span> <span class="keyword">implements</span> <span class="title">Iterable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// nested class</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ListIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> max = <span class="number">10</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> i++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> i &gt; max;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ListIterator();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，就可以 iterate 一个 List 了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List list = <span class="keyword">new</span> List();</span><br><span class="line"><span class="keyword">for</span> (Object i : list) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 javascript 中也不例外，这样实现一个 Iterable ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> iterable = &#123;</span><br><span class="line">    [<span class="built_in">Symbol</span>.iterator]: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> iterator = &#123;</span><br><span class="line">            next: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> iteratorResult = &#123;</span><br><span class="line">                    done: i &gt; <span class="number">10</span>,</span><br><span class="line">                    value: i++</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">return</span> iteratorResult;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> iterator;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> item <span class="keyword">of</span> iterable) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(item);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h3><p>协程是一种抽象方式，可以让一个函数中途暂停返回一些东西，然后过一段时间后再继续执行。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">routine</span><span class="params">()</span></span> </span><br><span class="line">    <span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line">    coroutine.<span class="built_in">yield</span>(i)</span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line">    coroutine.<span class="built_in">yield</span>(i)</span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line">    coroutine.<span class="built_in">yield</span>(i)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>调用三次 routine 后分别能得到 <code>1 2 3</code> 。原因是协程执行了一半被暂停后会保存下它自己的上下文，以便下次 resume后数据还在。</p>
<h3 id="Generator"><a href="#Generator" class="headerlink" title="Generator"></a>Generator</h3><p>Generator 相当于 javascript 中的协程，在一个 Generator 函数中使用 <code>yield</code> 关键字，可以暂停函数执行，返回一个结果。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 符号 * 代表 generator</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">routine</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">yield</span> i++;</span><br><span class="line">    <span class="keyword">yield</span> i++;</span><br><span class="line">    <span class="keyword">yield</span> i++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码和上面的 lua 代码等价。</p>
<p>使用 generator 函数可以方便的实现一个 iterator：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">iterable = &#123;</span><br><span class="line">    [<span class="built_in">Symbol</span>.iterator]: <span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">            <span class="keyword">yield</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> item <span class="keyword">of</span> iterable) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(item);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和上面的 iterable 代码等价，但是可以使用 for 循环了，是不是简洁多了？</p>
<h3 id="await-amp-async"><a href="#await-amp-async" class="headerlink" title="await &amp; async"></a>await &amp; async</h3><p>可能大家已经想到了，async 函数就是被翻译成了 generator 函数，ya。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getArticle</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> test = $(<span class="string">'.test'</span>);</span><br><span class="line">    <span class="keyword">var</span> comments = <span class="keyword">await</span> getComments();</span><br><span class="line">    test.append(<span class="string">'&lt;p&gt;'</span> + <span class="built_in">JSON</span>.stringify(comments) + <span class="string">'&lt;/p&gt;'</span>);</span><br><span class="line">    <span class="keyword">var</span> posts = <span class="keyword">await</span> getPosts();</span><br><span class="line">    test.append(<span class="string">'&lt;p&gt;'</span> + <span class="built_in">JSON</span>.stringify(posts) + <span class="string">'&lt;/p&gt;'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 翻译成=====&gt; </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">getArticle</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> test = $(<span class="string">'.test'</span>);</span><br><span class="line">    <span class="keyword">var</span> comments = <span class="keyword">yield</span> getComments();</span><br><span class="line">    test.append(<span class="string">'&lt;p&gt;'</span> + <span class="built_in">JSON</span>.stringify(comments) + <span class="string">'&lt;/p&gt;'</span>);</span><br><span class="line">    <span class="keyword">var</span> posts = <span class="keyword">yield</span> getPosts();</span><br><span class="line">    test.append(<span class="string">'&lt;p&gt;'</span> + <span class="built_in">JSON</span>.stringify(posts) + <span class="string">'&lt;/p&gt;'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当调用一个 async 函数时，实际上是这样做的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">getArticle();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 翻译成&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;</span><br><span class="line"></span><br><span class="line">runner(getArticle);</span><br><span class="line"></span><br><span class="line">function runner(getIterator) &#123;</span><br><span class="line">    var iterator &#x3D; getIterator();</span><br><span class="line">    function next(data) &#123;</span><br><span class="line">        var result &#x3D; iterator.next(data);</span><br><span class="line">        if (result.done)&#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        var promise &#x3D; result.value;</span><br><span class="line">        promise.then(function (data) &#123;</span><br><span class="line">            next(data);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    next();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="拓展篇"><a href="#拓展篇" class="headerlink" title="拓展篇"></a>拓展篇</h2><h3 id="1-在-NodeJS-中避免大规模计算"><a href="#1-在-NodeJS-中避免大规模计算" class="headerlink" title="1. 在 NodeJS 中避免大规模计算"></a>1. 在 NodeJS 中避免大规模计算</h3><p>Javascript 只有一根线程，如果用 for 循环来计算 10000 个数字的和，整个 vm 都非卡死不行。</p>
<p>以前大家都用 <code>setTimeout / setInterval</code> 来把运算拆开来做：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> output = $(<span class="string">'.power'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> i = <span class="number">0</span>, end = <span class="number">10000</span>;</span><br><span class="line">	<span class="keyword">var</span> cancel = setInterval(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">let</span> p = i * i;</span><br><span class="line">		output.append(<span class="string">`&lt;p&gt;<span class="subst">$&#123;p&#125;</span>&lt;/p&gt;`</span>);</span><br><span class="line">		<span class="keyword">if</span> (++i &gt;= end) &#123;</span><br><span class="line">			clearInterval(cancel);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在可以用 await 了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPower</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">		setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">			resolve(x * x);</span><br><span class="line">		&#125;, <span class="number">0</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> output = $(<span class="string">'.power'</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">		<span class="keyword">let</span> p = <span class="keyword">await</span> getPower(i);</span><br><span class="line">		output.append(<span class="string">`&lt;p&gt;<span class="subst">$&#123;p&#125;</span>&lt;/p&gt;`</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这两种都不会卡 vm 但是第二种显然直观一些。</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p><a href="https://github.com/zwh8800/analyse-await" target="_blank" rel="noopener">https://github.com/zwh8800/analyse-await</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/es2015/">es2015</a><a href="/tags/javascript/">javascript</a><a href="/tags/await/">await</a><a href="/tags/stage3/">stage3</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/04/20/await-async深度剖析/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/04/16/使用lua编写socks5代理/"><span>使用 lua 编写 socks5 代理</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/04/16/使用lua编写socks5代理/" rel="bookmark">
        <time class="entry-date published" datetime="2016-04-16T18:43:47.000Z">
          2016-04-16
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>之前做过一个有趣的东西，把<a href="https://lengzzz.com/note/archive-20151015">一部分 NodeJS 的 API 移植到了 lua 上</a>。让我可以在 lua 里使用异步网络 API 了，我把做的这个小东西叫做 <a href="https://github.com/zwh8800/lua-libuv" target="_blank" rel="noopener">lua-libuv</a>。今天去参加了一下 Gopher China 2016 中间听得无聊了，便打开电脑，基于自己的 lua-libuv 编写了一个 socks5 协议的 proxy。这篇博客，讲解一下 socks5 协议以及实现。</p>
<p><a href="/notename/" title="socks5 proxy in lua"></a></p>
<p>[toc]</p>
<h2 id="socks5-协议介绍"><a href="#socks5-协议介绍" class="headerlink" title="socks5 协议介绍"></a>socks5 协议介绍</h2><p>socks5 协议可能是中国网友见得最多的协议了。很多著名的工具 都就会在本机的 1080 端口开启一个 socks5 proxy 服务，供浏览器来调用。我们今天就来聊一聊 socks5 协议。</p>
<p>socks5 协议不只是在中国流行，它其实是最常见的代理协议之一，几乎所有浏览器都会原生支持 socks5 协议，而在 <i class="icon-apple"></i> Mac 上则是系统级别的支持，所以可见其流行程度仅次于 http 代理。由于 socks5 是工作在 tcp 层的协议，所以它又比 http 代理灵活很多。比如 http 代理只能用来看网页。但是使用 socks5 协议还可以上外网打游戏，也可以使用代理登陆 QQ 。但是 socks5 也有自己的短板，比如对 udp 支持的不好（socks5 把域名 resolve 的事都做了，就为了避免 client 调用 udp ）</p>
<h2 id="socks5-协议详解"><a href="#socks5-协议详解" class="headerlink" title="socks5 协议详解"></a>socks5 协议详解</h2><p>socks5 协议非常简单，<a href="https://www.ietf.org/rfc/rfc1928.txt" target="_blank" rel="noopener">rfc1928</a> 整个只有 9 页，我大概用了 10 分钟粗略看了一下就明白 socks5 的设计了。</p>
<h3 id="端口"><a href="#端口" class="headerlink" title="端口"></a>端口</h3><p>socks5 一般回使用 1080 端口来提供服务。</p>
<h3 id="握手"><a href="#握手" class="headerlink" title="握手"></a>握手</h3><p>socks5 协议使用四次应答式的握手建立一个链接。分别会</p>
<ul>
<li>client：协商method</li>
<li>server：选用method</li>
<li>client：发起请求</li>
<li>server：处理请求并回复</li>
</ul>
<p>四次握手结束之后，client 会把代理服务器当作是自己真正想通讯的服务器一样对待。而代理则会转发真正的通讯信息。</p>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><h4 id="1-协商-method"><a href="#1-协商-method" class="headerlink" title="1. 协商 method"></a>1. 协商 method</h4><p>当一个客户端需要建立一个 firewall 之外的连接时，首先向 socks5 服务器的 1080 端口发起一个 tcp 连接。</p>
<p>随后，客户端向服务器提供自己支持的 method 列表。数据的 payload 如下：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">+++</span>+</span><br><span class="line">|VER | NMETHODS | METHODS  |</span><br><span class="line"><span class="code">+++</span>+</span><br><span class="line">| 1  |    1     | 1 to 255 |</span><br><span class="line"><span class="code">+++</span>+</span><br></pre></td></tr></table></figure>

<p>上面是字段名，下面是字段长度。</p>
<p>字段分别是：</p>
<ul>
<li>版本号，对于 socks5 来说始终为5</li>
<li>method 个数</li>
<li>method 列表，个数需要和第二个字段相同，不能超过255</li>
</ul>
<p>method 的选项有如下几项，不过我感觉最常用的也就是第一个了。</p>
<ul>
<li>0x00: 无需授权</li>
<li>0x01: GSSAPI</li>
<li>0x02: 用户名／密码授权</li>
<li>0x03 - 0x7f: IANA ASSIGNED</li>
<li>0x80 - 0xfe: 私有 method</li>
<li>0xff: 用于服务器向客户端返回不支持此 method 的错误代码</li>
</ul>
<h4 id="2-选择-method"><a href="#2-选择-method" class="headerlink" title="2. 选择 method"></a>2. 选择 method</h4><p>服务器接到请求之后，应当选用一种 method 返回给客户端：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">+++</span></span><br><span class="line">|VER | METHOD |</span><br><span class="line"><span class="code">+++</span></span><br><span class="line">| 1  |   1    |</span><br><span class="line"><span class="code">+++</span></span><br></pre></td></tr></table></figure>

<p>之后如果 method 是需要鉴权的，会进行相应的鉴权。这里不谈了。</p>
<h4 id="3-请求"><a href="#3-请求" class="headerlink" title="3. 请求"></a>3. 请求</h4><p>之后客户端把自己想要连接的信息封成一个请求发给 proxy 。格式如下：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">+++</span><span class="code">+++</span>+</span><br><span class="line">|VER | CMD |  RSV  | ATYP | DST.ADDR | DST.PORT |</span><br><span class="line"><span class="code">+++</span><span class="code">+++</span>+</span><br><span class="line">| 1  |  1  | X'00' |  1   | Variable |    2     |</span><br><span class="line"><span class="code">+++</span><span class="code">+++</span>+</span><br></pre></td></tr></table></figure>

<p>其中，</p>
<ul>
<li>VER 还是代表版本，始终为 0x05</li>
<li>CMD 代表命令，表示建立连接还是监听连接<ul>
<li>0x01: Connect，连接其他服务器</li>
<li>0x02: Bind，监听端口</li>
<li>0x03: 建立udp连接</li>
</ul>
</li>
<li>保留</li>
<li>地址类型<ul>
<li>0x01: IPv4</li>
<li>0x03: DomainName</li>
<li>0x04: IPv6</li>
</ul>
</li>
<li>目的地址</li>
<li>目的端口</li>
</ul>
<p>这里面，命令又会有三种情况。如上，udp因为没有建立连接这一步，所以监听和连接是等同的。</p>
<p>地址类型也是，当地址类型不同时，目的地址的长度会不一样</p>
<ul>
<li>IPv4: 4 字节</li>
<li>DomainName: 目的地址的第一个字节代表域名长度</li>
<li>IPv6: 16 字节</li>
</ul>
<p>所以需要按照 ATYP 来读取目的地址。</p>
<h4 id="4-回复"><a href="#4-回复" class="headerlink" title="4. 回复"></a>4. 回复</h4><p>服务器收到请求后，需要向目的地址建立连接，如果失败了，需要告诉客户端原因。如果成功了，也需要告诉客户端代理服务器使用的地址和端口信息。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">+++</span><span class="code">+++</span>+</span><br><span class="line">|VER | REP |  RSV  | ATYP | BND.ADDR | BND.PORT |</span><br><span class="line"><span class="code">+++</span><span class="code">+++</span>+</span><br><span class="line">| 1  |  1  | X'00' |  1   | Variable |    2     |</span><br><span class="line"><span class="code">+++</span><span class="code">+++</span>+</span><br></pre></td></tr></table></figure>

<ul>
<li>VER 还是代表版本，始终为 0x05</li>
<li>REP 代表返回值<ul>
<li>0x00: 成功</li>
<li>0x01: socks 服务器错误</li>
<li>0x02: 不允许访问</li>
<li>0x03: Network unreachable</li>
<li>0x04: Host unreachable</li>
<li>0x05: Connection refused</li>
<li>0x06: TTL expired</li>
<li>0x07: Command not supported</li>
<li>0x08: Address type not supported</li>
</ul>
</li>
<li>保留</li>
<li>地址类型</li>
</ul>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>假如浏览器访问 <a href="https://lengzzz.com">https://lengzzz.com</a> 需要如下对话</p>
<blockquote>
<p>05 01 00</p>
<blockquote>
<p>05 00</p>
</blockquote>
</blockquote>
<blockquote>
<p>05 01 00 03(ATYP) 0b(LEN) 6c 65 6e 67 7a 7a 7a 2e 63 6f 6d(DOMAINNAME) 01 bb(PORT)</p>
<blockquote>
<p>05 00 00 01(ATYP) 0a 00 00 11(IP) e9 c7(PORT)</p>
</blockquote>
</blockquote>
<h2 id="Lua-实现"><a href="#Lua-实现" class="headerlink" title="Lua 实现"></a>Lua 实现</h2><p>大概就是用了两个函数来 parse 出 client 的 payload ，分别 parse 协商 method 阶段的 payload 和请求阶段的 payload 。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseMethodPayload</span><span class="params">(payload)</span></span></span><br><span class="line">    <span class="keyword">if</span> payload:<span class="built_in">byte</span>(<span class="number">1</span>) ~= SocksVersion <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, Errors.VersionError</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> method = &#123;</span><br><span class="line">        version = SocksVersion,</span><br><span class="line">        methods = &#123;&#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> methodCount = payload:<span class="built_in">byte</span>(<span class="number">2</span>)</span><br><span class="line">    method.methods = &#123;payload:<span class="built_in">byte</span>(<span class="number">3</span>, <span class="number">3</span> + methodCount - <span class="number">1</span>)&#125;</span><br><span class="line">    <span class="keyword">return</span> method</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseRequestPayload</span><span class="params">(payload)</span></span></span><br><span class="line">    <span class="keyword">if</span> payload:<span class="built_in">byte</span>(<span class="number">1</span>) ~= SocksVersion <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, Errors.VersionError</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> request = &#123;</span><br><span class="line">        version = SocksVersion,</span><br><span class="line">        command = CommandType.Connect,</span><br><span class="line">        addressType = AddressType.IPv4,</span><br><span class="line">        distAddress = <span class="string">''</span>,</span><br><span class="line">        distPort = <span class="number">0</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> payload:<span class="built_in">byte</span>(<span class="number">2</span>) &gt; CommandType.Udp <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, Errors.CommandTypeNotSupported</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        request.command = payload:<span class="built_in">byte</span>(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> requestAddressType = payload:<span class="built_in">byte</span>(<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">if</span>  requestAddressType ~= AddressType.IPv4 <span class="keyword">and</span></span><br><span class="line">        requestAddressType ~= AddressType.DomainName <span class="keyword">and</span></span><br><span class="line">        requestAddressType ~= AddressType.IPv6</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, Errors.AddressTypeNotSupported</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        request.addressType = requestAddressType</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> portIndex</span><br><span class="line">    <span class="keyword">if</span> request.addressType == AddressType.IPv4 <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> ipBytes = &#123;payload:<span class="built_in">byte</span>(<span class="number">5</span>, <span class="number">8</span>)&#125;</span><br><span class="line">        request.distAddress = <span class="built_in">table</span>.<span class="built_in">concat</span>(ipBytes, <span class="string">'.'</span>)</span><br><span class="line">        portIndex = <span class="number">9</span></span><br><span class="line">    <span class="keyword">elseif</span> request.addressType == AddressType.DomainName <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> <span class="built_in">len</span> = payload:<span class="built_in">byte</span>(<span class="number">5</span>)</span><br><span class="line">        request.distAddress = payload:<span class="built_in">sub</span>(<span class="number">6</span>, <span class="number">6</span> + <span class="built_in">len</span> - <span class="number">1</span>)</span><br><span class="line">        portIndex = <span class="number">5</span> + <span class="built_in">len</span> + <span class="number">1</span></span><br><span class="line">    <span class="keyword">elseif</span> request.addressType == AddressType.IPv6 <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, Errors.AddressTypeNotSupported</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> portBytes = &#123;payload:<span class="built_in">byte</span>(portIndex, portIndex + <span class="number">1</span>) &#125;</span><br><span class="line">    request.distPort = portBytes[<span class="number">1</span>] * <span class="number">256</span> + portBytes[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> request, <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>比较关键的就是这里，在会场写的，还是比较糙了。详细的代码看 <a href="https://github.com/zwh8800/lua-libuv/blob/master/test/socksProxy.lua" target="_blank" rel="noopener"><i class="icon-github"></i> Github</a> 就好啦：</p>
<p><a href="https://github.com/zwh8800/lua-libuv/blob/master/test/socksProxy.lua" target="_blank" rel="noopener">https://github.com/zwh8800/lua-libuv/blob/master/test/socksProxy.lua</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/网络编程/">网络编程</a><a href="/tags/lua/">lua</a><a href="/tags/libuv/">libuv</a><a href="/tags/socks5/">socks5</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/04/16/使用lua编写socks5代理/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/04/16/迅雷远程下载xware-docker镜像/"><span>迅雷远程下载 xware-docker 镜像</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/04/16/迅雷远程下载xware-docker镜像/" rel="bookmark">
        <time class="entry-date published" datetime="2016-04-16T13:00:10.000Z">
          2016-04-16
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>迅雷为广大路由器爱好者，nas爱好者，服务器爱好者提供了一个很好的平台－－xware 远程下载。只需要很简单的就能部署到你的路由器、树莓派之类的闲置机器上，然后只需要通过网站 <a href="http://yuancheng.xunlei.com/" target="_blank" rel="noopener">http://yuancheng.xunlei.com/</a> 就能远程提交下载任务，无论你是在公司还是外出。当你回到家里时，疲惫的打开电视，发现你想看的影片已经下载到服务器中了。简直是高清爱好者的福音。其实迅雷的 xware 部署起来已经很方便了，但是我为了<strong>更方便的启停服务</strong>就做了个 docker 镜像。</p>
<p>地址在这里： <a href="https://hub.docker.com/r/zwh8800/xware/" target="_blank" rel="noopener">https://hub.docker.com/r/zwh8800/xware/</a></p>
<p><a href="/notename/" title="xunlei xware docker image"></a></p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p>首先，拉取我的xware for docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull zwh8800/xware</span><br></pre></td></tr></table></figure>

<p>之后，启动它，需要指定一个 volume 挂在到 <code>/data</code> ，xware 所有下载的东西会保存到这个 volume 中。否则下载的东西会保存到容器中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --security-opt=seccomp:unconfined --name xware -v /var/lib/xware/:/data -d zwh8800/xware</span><br></pre></td></tr></table></figure>

<p>之后，第一次运行 xware 需要绑定一下你的迅雷账号，执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs xware</span><br></pre></td></tr></table></figure>

<p>会看到类似</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">initing...</span></span><br><span class="line"><span class="string">try</span> <span class="string">stopping</span> <span class="string">xunlei</span> <span class="string">service</span> <span class="string">first...</span></span><br><span class="line"><span class="attr">killall: ETMDaemon:</span> <span class="literal">no</span> <span class="string">process</span> <span class="string">killed</span></span><br><span class="line"><span class="attr">killall: EmbedThunderManager:</span> <span class="literal">no</span> <span class="string">process</span> <span class="string">killed</span></span><br><span class="line"><span class="attr">killall: vod_httpserver:</span> <span class="literal">no</span> <span class="string">process</span> <span class="string">killed</span></span><br><span class="line"><span class="string">setting</span> <span class="string">xunlei</span> <span class="string">runtime</span> <span class="string">env...</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">9000</span> <span class="string">is</span> <span class="string">usable.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">YOUR CONTROL PORT IS:</span> <span class="number">9000</span></span><br><span class="line"></span><br><span class="line"><span class="string">starting</span> <span class="string">xunlei</span> <span class="string">service...</span></span><br><span class="line"><span class="string">Connecting</span> <span class="string">to</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9000</span> <span class="string">(127.0.0.1:9000)</span></span><br><span class="line"><span class="string">setting</span> <span class="string">xunlei</span> <span class="string">runtime</span> <span class="string">env...</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">9000</span> <span class="string">is</span> <span class="string">usable.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">YOUR CONTROL PORT IS:</span> <span class="number">9000</span></span><br><span class="line"></span><br><span class="line"><span class="string">starting</span> <span class="string">xunlei</span> <span class="string">service...</span></span><br><span class="line"></span><br><span class="line"><span class="string">getting</span> <span class="string">xunlei</span> <span class="string">service</span> <span class="string">info...</span></span><br><span class="line"></span><br><span class="line"><span class="attr">THE ACTIVE CODE IS:</span> <span class="string">vghqnv</span></span><br><span class="line"></span><br><span class="line"><span class="string">go</span> <span class="string">to</span> <span class="string">http://yuancheng.xunlei.com,</span> <span class="string">bind</span> <span class="string">your</span> <span class="string">device</span> <span class="string">with</span> <span class="string">the</span> <span class="string">active</span> <span class="string">code.</span></span><br><span class="line"><span class="string">finished.</span></span><br></pre></td></tr></table></figure>
<p>的内容，把 active code 复制一下，打开 <a href="http://yuancheng.xunlei.com" target="_blank" rel="noopener">http://yuancheng.xunlei.com</a> 点击 <code>我的下载器</code> 旁边的 <code>添加</code> 把 active code 输入进去。</p>
<center>
![添加][1]
</center>

<center>
![激活码][2]
</center>

<p>然后，就可以使用了。</p>
<p>最后，最好在你的 <code>/etc/rc.local</code> 中添加上开机启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start xware</span><br></pre></td></tr></table></figure>

<p>这样，down机重启后也会自动打开xware。</p>
<h2 id="have-fun"><a href="#have-fun" class="headerlink" title="have fun"></a>have fun</h2>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/docker/">docker</a><a href="/tags/xware/">xware</a><a href="/tags/迅雷/">迅雷</a><a href="/tags/远程下载/">远程下载</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/04/16/迅雷远程下载xware-docker镜像/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/04/15/下载站我又重新打开了/"><span>下载站我又重新打开了</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/04/15/下载站我又重新打开了/" rel="bookmark">
        <time class="entry-date published" datetime="2016-04-15T09:54:21.000Z">
          2016-04-15
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>之前在 <a href="https://lengzzz.com/download">https://lengzzz.com/download</a> <i class="icon-download"></i>  下放了一些文件，主要是研究嵌入式的时候收集的一些文档和镜像之类的东西。换了 nginx 之后，我默认把索引页给关闭了，不过没想到看日志还真的有那么两三个人访问这个页面，所以我又把 <code>autoindex</code> 加上了。</p>
<p>没了，就是这样。</p>
<p><a href="/notename/" title="download site"></a></p>
<p>真没了。</p>
<p><a href="https://lengzzz.com/download">https://lengzzz.com/download</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/闲扯/">闲扯</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/04/15/下载站我又重新打开了/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/04/14/短链接生成算法/"><span>短链接生成算法</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/04/14/短链接生成算法/" rel="bookmark">
        <time class="entry-date published" datetime="2016-04-14T13:44:11.000Z">
          2016-04-14
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>最早 twitter 推出短链接服务之后，各大互联网企业也都跟进推出了自己的短链接服务，就连我们公司最近也有了这个需求。短链接形如 <a href="http://t.cn/R7gyvR4" target="_blank" rel="noopener"><code>http://t.cn/R7gyvR4</code></a> ，不仅好看而且能宏观上减少互联网的通讯量。这里记录下我做短链接的过程。</p>
<p><a href="/notename/" title="short url algorithm"></a></p>
<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>首先短链接算法有两个基本需求：</p>
<ul>
<li>快</li>
<li>碰撞少</li>
</ul>
<p>所以那种生产随机数，然后碰撞的算法肯定排除在外了，太过暴力，到后期碰撞绝对会相当严重。而 hash 算法可以算是正好能同时满足这两点需求，所以路线大概是怎么能改造一下现有的 hash 算法。</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>常见 hash 算法有 md5 和 sha1 两种， md5 已经被证明不安全，很容易由 hash 值推出原始数据。但是我们这里只对 hash 算法的碰撞率感兴趣，和安全性关系不大，所以还是选用 md5 算法。</p>
<p>md5 算法的输出是固定的 16 个字节（byte），也就是 128 位（bit），大概有 $2^{128}$ 种情况。我们的需求是使用 6 位 <code>大小写字母加数字</code> 做短链接，大概可以表示 $62^6$ 种情况。是少于 md5 算法的，所以思路可以是取 md5 值的一部分，然后生成短链接。</p>
<p>好的，首先可以把62个字符列一张表。比如这样：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 62个字符, 需要6bit做索引(2 ^ 6 = 64)</span></span><br><span class="line"><span class="keyword">var</span> charTable = [...]<span class="keyword">rune</span>&#123;</span><br><span class="line">	<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>, <span class="string">'g'</span>, <span class="string">'h'</span>, <span class="string">'i'</span>, <span class="string">'j'</span>, <span class="string">'k'</span>,</span><br><span class="line">	<span class="string">'l'</span>, <span class="string">'m'</span>, <span class="string">'n'</span>, <span class="string">'o'</span>, <span class="string">'p'</span>, <span class="string">'q'</span>, <span class="string">'r'</span>, <span class="string">'s'</span>, <span class="string">'t'</span>, <span class="string">'u'</span>, <span class="string">'v'</span>,</span><br><span class="line">	<span class="string">'w'</span>, <span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>, <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>,</span><br><span class="line">	<span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>, <span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>, <span class="string">'E'</span>, <span class="string">'F'</span>, <span class="string">'G'</span>, <span class="string">'H'</span>,</span><br><span class="line">	<span class="string">'I'</span>, <span class="string">'J'</span>, <span class="string">'K'</span>, <span class="string">'L'</span>, <span class="string">'M'</span>, <span class="string">'N'</span>, <span class="string">'O'</span>, <span class="string">'P'</span>, <span class="string">'Q'</span>, <span class="string">'R'</span>, <span class="string">'S'</span>,</span><br><span class="line">	<span class="string">'T'</span>, <span class="string">'U'</span>, <span class="string">'V'</span>, <span class="string">'W'</span>, <span class="string">'X'</span>, <span class="string">'Y'</span>, <span class="string">'Z'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么，如果一个网址的 md5 值是 0 可以在短链接中用 <code>a</code> 表示 ，同理用 <code>b</code> 代表 1 。</p>
<p>按照这个思路，我来举个例子。</p>
<p>比如 <a href="https://lengzzz.com">https://lengzzz.com</a> 的 md5 值是 <code>3CD4B16B4855CF2DBEB9051867665045</code> ，第一个字节是 <code>0x3c</code> ，十进制值为 <code>60</code> 那么在表中第 60 个是 Y ，那么用 Y 来表示 0x3c 。</p>
<p>但是这个思路还略有不妥，万一字节超了61就不行了。所以我们对字节使用 <code>% 0x3d</code> 取余运算，因为 0x3d 即为62，所以得到的数不会超出。</p>
<p>例如 <code>0xd4</code> ，十进制为 <code>212</code> 显然超出了，但是 <code>0xd4 % 0x3d</code> 等于 <code>26</code> ，第 26 个字符是 ‘0’ ，所以可以用 ‘0’ 来表示。</p>
<p>因此，我们可以把 md5 的输出分为 4 份，每份 4 个字节（byte）。4 个字节又可以分成 6 份，每份 5 位（bit）共 30 位（bit），这样正好是在使用一个 <code>uint32</code> 计算，效率较高。</p>
<h2 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h2><p>公司里是用 java 实现的，我再写一个 golang 的版本：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> util</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bytes"</span></span><br><span class="line">	<span class="string">"crypto/md5"</span></span><br><span class="line">	<span class="string">"encoding/binary"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 62个字符, 需要6bit做索引(2 ^ 6 = 64)</span></span><br><span class="line"><span class="keyword">var</span> charTable = [...]<span class="keyword">rune</span>&#123;</span><br><span class="line">	<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>, <span class="string">'g'</span>, <span class="string">'h'</span>, <span class="string">'i'</span>, <span class="string">'j'</span>, <span class="string">'k'</span>,</span><br><span class="line">	<span class="string">'l'</span>, <span class="string">'m'</span>, <span class="string">'n'</span>, <span class="string">'o'</span>, <span class="string">'p'</span>, <span class="string">'q'</span>, <span class="string">'r'</span>, <span class="string">'s'</span>, <span class="string">'t'</span>, <span class="string">'u'</span>, <span class="string">'v'</span>,</span><br><span class="line">	<span class="string">'w'</span>, <span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>, <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>,</span><br><span class="line">	<span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>, <span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>, <span class="string">'E'</span>, <span class="string">'F'</span>, <span class="string">'G'</span>, <span class="string">'H'</span>,</span><br><span class="line">	<span class="string">'I'</span>, <span class="string">'J'</span>, <span class="string">'K'</span>, <span class="string">'L'</span>, <span class="string">'M'</span>, <span class="string">'N'</span>, <span class="string">'O'</span>, <span class="string">'P'</span>, <span class="string">'Q'</span>, <span class="string">'R'</span>, <span class="string">'S'</span>,</span><br><span class="line">	<span class="string">'T'</span>, <span class="string">'U'</span>, <span class="string">'V'</span>, <span class="string">'W'</span>, <span class="string">'X'</span>, <span class="string">'Y'</span>, <span class="string">'Z'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ShortenUrl</span><span class="params">(url <span class="keyword">string</span>)</span> []<span class="title">string</span></span> &#123;</span><br><span class="line">	shortUrlList := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">0</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">	sumData := md5.Sum([]<span class="keyword">byte</span>(url))</span><br><span class="line">	<span class="comment">// 把md5sum分成4份, 每份4个字节</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">4</span>; i++ &#123;</span><br><span class="line">		part := sumData[i*<span class="number">4</span> : i*<span class="number">4</span>+<span class="number">4</span>]</span><br><span class="line">		<span class="comment">// 将4字节当作一个整数</span></span><br><span class="line">		partUint := binary.BigEndian.Uint32(part)</span><br><span class="line"></span><br><span class="line">		shortUrlBuffer := &amp;bytes.Buffer&#123;&#125;</span><br><span class="line">		<span class="comment">// 将30bit分成6份, 每份5bit</span></span><br><span class="line">		<span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="number">6</span>; j++ &#123;</span><br><span class="line">			index := partUint % <span class="number">62</span></span><br><span class="line"></span><br><span class="line">			shortUrlBuffer.WriteRune(charTable[index])</span><br><span class="line">			partUint = partUint &gt;&gt; <span class="number">5</span></span><br><span class="line">		&#125;</span><br><span class="line">		shortUrlList = <span class="built_in">append</span>(shortUrlList, shortUrlBuffer.String())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> shortUrlList</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释比较完善，可以和文章对应着看。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/golang/">golang</a><a href="/tags/算法/">算法</a><a href="/tags/短链接/">短链接</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/04/14/短链接生成算法/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/04/12/键步如飞！高效bash快捷键/"><span>键步如飞！高效bash快捷键</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/04/12/键步如飞！高效bash快捷键/" rel="bookmark">
        <time class="entry-date published" datetime="2016-04-12T15:30:41.000Z">
          2016-04-12
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>程序员们每天面对最多的就是自己的terminal了，所以一定要把terminal配置的高效起来，这样不但提高工作效率，而且令人身心舒畅。</p>
<p><a href="/notename/" title="bash hotkey"></a></p>
<p>[toc]</p>
<p><img src="/images/6edcb8ffc969d2e387e32c5aba2302a0.png" alt="iTerm2"></p>
<p>首先打开你的 iterm2 的 <code>Preferences</code> ，点击 <code>profile</code> 选项卡，再点击一下 <code>key</code> 子选项卡，把里面的 <code>Left option acts as</code> 设置成 +Esc 。这样按 <code>option</code> 键就不会出现奇奇怪怪的字符了。</p>
<p>下面，介绍几个用的比较爽的快捷键：</p>
<h2 id="按单词移动光标"><a href="#按单词移动光标" class="headerlink" title="按单词移动光标"></a>按单词移动光标</h2><ul>
<li><code>option+b</code> ：前移一个单词</li>
<li><code>option+f</code> ：后移一个单词</li>
</ul>
<p>其中 b 和 f 分别是 backward 和 forward 的意思，这样是不是比较容易背了。</p>
<h2 id="移动到行首行尾"><a href="#移动到行首行尾" class="headerlink" title="移动到行首行尾"></a>移动到行首行尾</h2><ul>
<li><code>fn+left</code> ：移动到行首</li>
<li><code>fn+right</code> ：移动到行尾</li>
<li><code>control+a</code> ：移动到行首</li>
<li><code>control+e</code> ：移动到行尾</li>
</ul>
<p>fn+left 和 fn+right 其实是 Mac 自带的功能，分别对应大键盘上的 Home 和 End 键，此外 fn+up 和 fn+down 对应 PgUp 和 PgDown。</p>
<p>a 和 e 可以记忆为 <code>第一个字母</code> 和 <code>end</code> :)</p>
<h2 id="删除命令"><a href="#删除命令" class="headerlink" title="删除命令"></a>删除命令</h2><ul>
<li><code>control+w</code> ：删除一个单词</li>
<li><code>control+u</code> ：删除一行</li>
<li><code>control+l</code> ：清屏</li>
</ul>
<p>w 可以认为是word</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>使用 <code>control+r</code> 可以搜索最近使用的命令。另外，bash中也可以配置autojump。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install autojump</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'[[ -s $(brew --prefix)/etc/profile.d/autojump.sh ]] &amp;&amp; . $(brew --prefix)/etc/profile.d/autojump.sh'</span> &gt;&gt; ~/.bash_profile</span><br></pre></td></tr></table></figure>

<p>重启下 terminal 现在可以使用命令 <code>j xxx</code> 了。autojump使用一个数据库，记录你最常使用的目录，你只需要打目录名字的一部分就可以 <code>jump</code> 到目录。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/bash/">bash</a><a href="/tags/mac技巧/">mac技巧</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/04/12/键步如飞！高效bash快捷键/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/04/10/在Linux下设置swap/"><span>在Linux下设置swap</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/04/10/在Linux下设置swap/" rel="bookmark">
        <time class="entry-date published" datetime="2016-04-10T07:31:11.000Z">
          2016-04-10
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>今早起来发现博客的数据库挂了，赶紧用手机上的ConnectBot连上去把mysql启动。看了下日志大概是因为内存不够用且没设置swap，所以mysql进程申请不到内存挂了（小内存服务器桑不起）所以赶紧把swap搞上，这样至少能让服务不轻易挂掉。</p>
<p>这里记录一下，以备遗忘。</p>
<p><a href="/notename/" title="add swap on linux"></a></p>
<p>大概分三步</p>
<ul>
<li>生成一个空文件</li>
<li>把文件格式化成swap格式</li>
<li>挂载</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create swap file</span></span><br><span class="line">sudo dd <span class="keyword">if</span>=/dev/zero of=/swapfile bs=128M count=4</span><br><span class="line"></span><br><span class="line"><span class="comment"># adjust permission</span></span><br><span class="line">sudo chmod 600 /swapfile</span><br><span class="line"></span><br><span class="line"><span class="comment"># format swap</span></span><br><span class="line">sudo mkswap /swapfile</span><br><span class="line"></span><br><span class="line"><span class="comment"># mount swap</span></span><br><span class="line">sudo swapon /swapfile</span><br><span class="line"></span><br><span class="line"><span class="comment"># see if ok</span></span><br><span class="line">sudo swapon -s</span><br></pre></td></tr></table></figure>

<p>没问题的话，最后一个命令会显示</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Filename			<span class="built_in">	Type	</span>	Size	Used	Priority</span><br><span class="line">/swapfile               file		524284	0	    -1</span><br></pre></td></tr></table></figure>

<p>另外，dd程序花的时间比较长，因为它确实写入东西了。但其实Linux的文件系统有个功能，它可以忽略（合并？）文件中的0，比如一个1G的文件，只有前面3个字节和后面3个字节写字了，其余都是0，那么在硬盘上只会记录几个字节，而不会把上G的0写到硬盘中，这样就能加快性能。</p>
<p>所以可以使用 <code>fallocate</code> 程序。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fallocate -l 512M /swapfile</span><br></pre></td></tr></table></figure>

<p>这个应该会很快。</p>
<p>最后，修改一下fstab，保证开机自动挂载：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="keyword">vim</span> /etc/fstab</span><br><span class="line"></span><br><span class="line"># <span class="keyword">write</span> this <span class="keyword">to</span> fstab</span><br><span class="line">/swapfile   none    swap    <span class="keyword">sw</span>    <span class="number">0</span>   <span class="number">0</span></span><br></pre></td></tr></table></figure>


      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/linux/">linux</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/04/10/在Linux下设置swap/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/04/07/golangtemplate学习笔记/"><span>golang template 学习笔记</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/04/07/golangtemplate学习笔记/" rel="bookmark">
        <time class="entry-date published" datetime="2016-04-07T07:05:57.000Z">
          2016-04-07
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>最近几天用golang写自己的博客系统，手贱选用了golang自己的template包做模版系统。发现这个模版里面好多不符合常识的地方，记录一下。（偷懒没直接用pongo2真是败笔</p>
<p><a href="/notename/" title="learning golang template"></a></p>
<p>[toc]</p>
<p>首先，golang的template分在两个package里，我一开始只看 <code>html/template</code> 包了，一直吐槽为什么文档这么不全，后来发现大部分功能在 <code>text/template</code> 里，html包只负责部分html特有的功能。</p>
<h2 id="Layout"><a href="#Layout" class="headerlink" title="Layout"></a>Layout</h2><p>先看两种常见的模版布局方式吧(都是伪代码)：</p>
<h3 id="1-include-方式"><a href="#1-include-方式" class="headerlink" title="1. include 方式"></a>1. include 方式</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- content.html --&gt;</span></span><br><span class="line">&#123;% raw %&#125;&#123;&#123; include "header.html" &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"content"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- content --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% raw %&#125;&#123;&#123; include "footer.html" &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line"><span class="comment">&lt;!-- end of content.html --&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- header.html --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span></span><br><span class="line">    xxx</span><br><span class="line">    <span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"xxx.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">media</span>=<span class="string">"screen"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"xxx.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- end of header.html --&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- footer.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- end end of footer.html --&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-layout-方式"><a href="#2-layout-方式" class="headerlink" title="2. layout 方式"></a>2. layout 方式</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- layout.html --&gt;</span></span><br><span class="line">&#123;% raw %&#125;&#123;&#123; define "layout" &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span></span><br><span class="line">    xxx</span><br><span class="line">    <span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"xxx.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">media</span>=<span class="string">"screen"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"xxx.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    &#123;% raw %&#125;&#123;&#123; template "moreStyles" &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    &#123;% raw %&#125;&#123;&#123; template "content" &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line">    &#123;% raw %&#125;&#123;&#123; template "moreScripts" &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line">&#123;% raw %&#125;&#123;&#123; end &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line"><span class="comment">&lt;!-- end of footer.html --&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;&#123;&#123; use "layout" &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line">&#123;% raw %&#125;&#123;&#123; define "content" &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line">    <span class="comment">&lt;!-- content --&gt;</span></span><br><span class="line">&#123;% raw %&#125;&#123;&#123; end &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line">&#123;% raw %&#125;&#123;&#123; define "moreScript" &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"you-script.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% raw %&#125;&#123;&#123; end &#125;&#125;&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-实现"><a href="#3-实现" class="headerlink" title="3. 实现"></a>3. 实现</h3><p>一般我习惯layout方式的模版，这样结构清晰，而且IDE友好。但是golang的template好像没有对layout格式的模版做<strong>特别的</strong>支持。只好找一种折衷的比较优雅的实现方式。</p>
<p>首先，在模版目录下新建一个 <code>common</code> 目录，用于存放各种公共的template。之后，在下面创建 <code>layout.html</code> 。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;&#123;&#123; define "layout" &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span></span><br><span class="line">    &#123;% raw %&#125;&#123;&#123; template "title" .&#125;&#125;&#123;% endraw %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"common.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line">    &#123;% raw %&#125;&#123;&#123; template "moreStyles" .&#125;&#125;&#123;% endraw %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    &#123;% raw %&#125;&#123;&#123; template "content" .&#125;&#125;&#123;% endraw %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"common.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    &#123;% raw %&#125;&#123;&#123; template "moreScripts" .&#125;&#125;&#123;% endraw %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line">&#123;% raw %&#125;&#123;&#123; end &#125;&#125;&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>这个文件使用action <code>define</code> 定义了一个叫做 <code>layout</code> 的模版，这个layout模版分别引用了 <code>title</code>、 <code>moreStyles</code>、 <code>content</code>、 <code>moreScripts</code> 这四个模版。</p>
<p>之后，在模版目录下新建真正的view，比如 <code>note.html</code>。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;&#123;&#123;/* 定义layout所需要的template */&#125;&#125;&#123;% endraw %&#125;</span><br><span class="line">&#123;% raw %&#125;&#123;&#123; define "title" &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line">&#123;% raw %&#125;&#123;&#123; .note.Title &#125;&#125; - &#123;&#123; .site.Name &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line">&#123;% raw %&#125;&#123;&#123; end &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line">&#123;% raw %&#125;&#123;&#123; define "moreHeaders" &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line">&#123;% raw %&#125;&#123;&#123; end &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line">&#123;% raw %&#125;&#123;&#123; define "moreStyles" &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"/static/css/note.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line">&#123;% raw %&#125;&#123;&#123; end &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line">&#123;% raw %&#125;&#123;&#123; define "moreScripts" &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/static/js/jquery-2.2.2.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/static/js/note.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// inline script</span></span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% raw %&#125;&#123;&#123; end &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line">&#123;% raw %&#125;&#123;&#123; define "content" &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">article</span> <span class="attr">class</span>=<span class="string">"note"</span>&gt;</span></span><br><span class="line">        &#123;% raw %&#125;&#123;&#123; .note.UnescapedContent &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">article</span>&gt;</span></span><br><span class="line">&#123;% raw %&#125;&#123;&#123; end &#125;&#125;&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;&#123;&#123;/* 引用layout，传入scope */&#125;&#125;&#123;% endraw %&#125;</span><br><span class="line">&#123;% raw %&#125;&#123;&#123; template "layout" . &#125;&#125;&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>

<p>这个需要文件定义所有被layout引用的模版项（为空也要定义），然后最重要的一句是 <code>{{ template "layout" . }}</code> 这里把 <code>.</code> 传给了layout，从而能使 <code>layout</code> 访问model。</p>
<p>总之golang的template只使用了两个关键字 <code>template</code> 和 <code>define</code> 完成这个工作，可以算好处也可以算坏处（不够直观）</p>
<p>最后，在代码中这样调用：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> templateDir = <span class="string">"template"</span></span><br><span class="line"><span class="keyword">const</span> commonDir = <span class="string">"common"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Render <span class="keyword">struct</span> &#123;</span><br><span class="line">	templateName <span class="keyword">string</span></span><br><span class="line">	template     <span class="keyword">string</span></span><br><span class="line">	data         <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRender</span><span class="params">(template <span class="keyword">string</span>, data <span class="keyword">interface</span>&#123;&#125;)</span> *<span class="title">Render</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Render&#123;</span><br><span class="line">		template,</span><br><span class="line">		path.Join(templateDir, template),</span><br><span class="line">		data,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Render)</span> <span class="title">Render</span><span class="params">(w http.ResponseWriter)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	util.WriteContentType(w, []<span class="keyword">string</span>&#123;<span class="string">"text/html; charset=utf-8"</span>&#125;)</span><br><span class="line">	t := template.New(<span class="string">""</span>)</span><br><span class="line">	<span class="keyword">if</span> _, err := t.ParseGlob(path.Join(templateDir, </span><br><span class="line">	    commonDir, <span class="string">"*"</span>)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> _, err := t.ParseFiles(r.template); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> t.ExecuteTemplate(w, r.templateName, r.data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外，可以在common里定义更多通用的小组件，以便调用，比如 <code>tag</code>、<code>article</code> 之类的。</p>
<h2 id="Unescape"><a href="#Unescape" class="headerlink" title="Unescape"></a>Unescape</h2><p>golang的escape做的很好，可以区分当前语境（<code>Contexts</code>)，把变量放到不同的地方会有不同的输出：</p>
<table>
<thead>
<tr>
<th>Context</th>
<th>{{.}} 的输出</th>
</tr>
</thead>
<tbody><tr>
<td><code>{{.}}</code></td>
<td><code>O&#39;Reilly: How are &amp;lt;i&amp;gt;you&amp;lt;/i&amp;gt;?</code></td>
</tr>
<tr>
<td><code>&lt;a title=&#39;{{.}}&#39;&gt;</code></td>
<td><code>O&amp;#39;Reilly: How are you?</code></td>
</tr>
<tr>
<td><code>&lt;a href=&quot;/{{.}}&quot;&gt;</code></td>
<td><code>O&amp;#39;Reilly: How are %3ci%3eyou%3c/i%3e?</code></td>
</tr>
<tr>
<td><code>&lt;a href=&quot;?q={{.}}&quot;&gt;</code></td>
<td><code>O&amp;#39;Reilly%3a%20How%20are%3ci%3e...%3f</code></td>
</tr>
<tr>
<td><code>&lt;a onx=&#39;f(&quot;{{.}}&quot;)&#39;&gt;</code></td>
<td><code>O\x27Reilly: How are \x3ci\x3eyou...?</code></td>
</tr>
<tr>
<td><code>&lt;a onx=&#39;f({{.}})&#39;&gt;</code></td>
<td><code>&quot;O\x27Reilly: How are \x3ci\x3eyou...?&quot;</code></td>
</tr>
<tr>
<td><code>&lt;a onx=&#39;pattern = /{{.}}/;&#39;&gt;</code></td>
<td><code>O\x27Reilly: How are \x3ci\x3eyou...\x3f</code></td>
</tr>
</tbody></table>
<p>假如 <code>{{.}}` 是 `O'Reilly: How are <i>you</i>?`，把 `{{.}}</code> 放到不同的地方会有不同的输出。</p>
<p>但是怎么让变量输出它本身的模样呢，<code>html/template</code> 提供了几个type来做这件事：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> (</span><br><span class="line">	CSS <span class="keyword">string</span></span><br><span class="line">	HTML <span class="keyword">string</span></span><br><span class="line">	JS <span class="keyword">string</span></span><br><span class="line">	JSStr <span class="keyword">string</span></span><br><span class="line">	URL <span class="keyword">string</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>假如在模版中</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% raw %&#125;&#123;&#123; .img.url &#125;&#125;&#123;% endraw %&#125;"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>是无法直接输出的。需要用到上面的几个类型。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">data := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">    url: template.URL(url),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其他的类似。</p>
<h2 id="Pipelines"><a href="#Pipelines" class="headerlink" title="Pipelines"></a>Pipelines</h2><p>golang起的这个名字有点奇怪，当作是 <code>expression</code> （表达式）就好了。有三种使用方法</p>
<ul>
<li>参数</li>
<li>.method [参数 参数 参数 …]</li>
<li>函数 [参数 参数 参数 …]</li>
</ul>
<p>是可以直接调用方法或函数的，不过不需要加小括号。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/golang/">golang</a><a href="/tags/template/">template</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/04/07/golangtemplate学习笔记/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>




<nav class="pagination">
  
  <a href="/page/2/" class="pagination-prev">上一页</a>
  
  
  <a href="/page/4/" class="pagination-next">下一页</a>
  
</nav>
    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2020 wastecat
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-47471611-1', 'auto');
    ga('send', 'pageview');

</script>

  </div>
</div>
</body>
</html>