<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>await &amp; async 深度剖析 | wastecat的博客</title>

  
  <meta name="author" content="wastecat">
  

  
  <meta name="description" content="await 语法最早被引入到流行语言是 c# 5.0 ，微软在 c# 中添加了 await &amp;amp; async 关键字和一系列配套 API ，引起了开发者的一致好评。await 可以极大的简化异步编程，而使用异步编程最多的就是 javascript 了。所以开发者们也迫不及待的向 javascr">
  

  
  
  <meta name="keywords" content="es2015,javascript,await,stage3">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="await &amp; async 深度剖析"/>

  <meta property="og:site_name" content="wastecat的博客"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="wastecat的博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 4.2.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">wastecat的博客</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/2020/04/29/hello-world/">关于</a></li>
      
        <li><a href="/atom.xml">订阅</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>await &amp; async 深度剖析</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/04/20/await-async深度剖析/" rel="bookmark">
        <time class="entry-date published" datetime="2016-04-20T04:54:20.000Z">
          2016-04-20
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>await 语法最早被引入到流行语言是 c# 5.0 ，微软在 c# 中添加了 <code>await &amp; async</code> 关键字和一系列配套 API ，引起了开发者的一致好评。await 可以极大的简化异步编程，而使用异步编程最多的就是 javascript 了。所以开发者们也迫不及待的向 javascript 中加入 await 关键字。目前此特性已经在 babel 中比较完美的实现了。而 await 特性也被加入了 <code>stage-3</code> （Candidate），不过貌似是赶不上今年的 ES2016 了，估计最晚会在 ES2017 中被正式加入 javascript 。那么本文就来深度剖析一下 <code>await &amp; async</code> 的用法、好处以及实现方式。</p>
<p><a href="/notename/" title="in depth analysis of await and async"></a></p>
<p>[toc]</p>
<h2 id="异步？同步？"><a href="#异步？同步？" class="headerlink" title="异步？同步？"></a>异步？同步？</h2><p>异步编程模型对于 IO 密集型的任务具有得天独厚的优势。这里用一个例子来解释。</p>
<p>假如我们需要做一个爬虫，爬到的东西有两种，一种是索引页，一种是内容页。大概需要以下几步：</p>
<ul>
<li>使用 http 请求一个索引页，从这个从索引中取出所有的 URL</li>
<li>分别请求所有的 URL</li>
<li>如果请求到的还是 <strong>索引页</strong> 那么递归这个操作（回到步骤 1 ）</li>
<li>如果是 <strong>内容页</strong> ，那么我们对内容页做一些处理</li>
<li>最后，把处理后的保存到数据库</li>
</ul>
<p>那么，分别使用原生支持异步编程的 NodeJS 和原生不支持异步编程 golang 的语言实现这个爬虫。分别使用两种语言 <strong>最常见</strong> 的实现方式。</p>
<blockquote>
<p><small>因为发 http 请求和保存数据库还需要一些额外代码，会干扰视线，所以例子代码是递归的读一个文件夹，并把所有 html 文件做一些修改，然后保存到源文件。但是原理上和爬虫是相通的。</small></p>
</blockquote>
<h3 id="golang-实现爬虫"><a href="#golang-实现爬虫" class="headerlink" title="golang 实现爬虫"></a>golang 实现爬虫</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"io/ioutil"</span></span><br><span class="line">  <span class="string">"log"</span></span><br><span class="line">  <span class="string">"path"</span></span><br><span class="line">  <span class="string">"path/filepath"</span></span><br><span class="line">  <span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> extname = <span class="string">".html"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> counter = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleDir</span><span class="params">(dir <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">  <span class="comment">// 读取文件夹列表</span></span><br><span class="line">  files, err := ioutil.ReadDir(dir)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Println(<span class="string">"error occurs when readDir"</span>, dir, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// iterate 文件列表</span></span><br><span class="line">  <span class="keyword">for</span> _, file := <span class="keyword">range</span> files &#123;</span><br><span class="line">    fullFilename := path.Join(dir, file.Name())</span><br><span class="line">    <span class="comment">// 判断文件类型</span></span><br><span class="line">    <span class="keyword">if</span> !file.IsDir() &amp;&amp; filepath.Ext(file.Name()) == extname &#123;</span><br><span class="line">      counter++</span><br><span class="line">      thisCount := counter</span><br><span class="line">      <span class="comment">// 打开始 log</span></span><br><span class="line">      log.Println(<span class="string">"start processing"</span>, fullFilename, </span><br><span class="line">        <span class="string">"["</span>, thisCount, <span class="string">"]"</span>)</span><br><span class="line">        </span><br><span class="line">      <span class="comment">// 读取文件</span></span><br><span class="line">      fileData, err := ioutil.ReadFile(fullFilename)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Println(<span class="string">"error occurs when processing"</span>, </span><br><span class="line">          fullFilename, err)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 做一些处理</span></span><br><span class="line">      fileString := <span class="keyword">string</span>(fileData)</span><br><span class="line">      fileString = strings.Replace(fileString, </span><br><span class="line">        <span class="string">"http://"</span>, <span class="string">"https://"</span>, <span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 保存文件</span></span><br><span class="line">      <span class="keyword">if</span> err := ioutil.WriteFile(fullFilename, </span><br><span class="line">          []<span class="keyword">byte</span>(fileString), <span class="number">0644</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Println(<span class="string">"error occurs when processing"</span>, </span><br><span class="line">          fullFilename, err)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 打结束 log</span></span><br><span class="line">      log.Println(<span class="string">"finish processing"</span>, fullFilename, </span><br><span class="line">        <span class="string">"["</span>, thisCount, <span class="string">"]"</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> file.IsDir() &#123;</span><br><span class="line">      <span class="comment">// 文件夹的话递归</span></span><br><span class="line">      handleDir(fullFilename)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  handleDir(<span class="string">"/Users/zzz/hzzz.lengzzz.com/"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="NodeJS-实现爬虫"><a href="#NodeJS-实现爬虫" class="headerlink" title="NodeJS 实现爬虫"></a>NodeJS 实现爬虫</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">'fs'</span>;</span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> counter = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> extname = <span class="string">'.html'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleDir</span>(<span class="params">dir</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 读取文件夹列表</span></span><br><span class="line">  fs.readdir(dir, <span class="function"><span class="keyword">function</span> (<span class="params">err, files</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// iterate 文件列表</span></span><br><span class="line">    files.map(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> fullFilename = path.join(dir, file);</span><br><span class="line">      fs.stat(fullFilename, <span class="function"><span class="keyword">function</span> (<span class="params">err, stats</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          <span class="built_in">console</span>.error(<span class="string">"error occurs when processing"</span>, file, err);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 判断文件类型</span></span><br><span class="line">        <span class="keyword">if</span> (stats.isFile() &amp;&amp; path.extname(file) == extname) &#123;</span><br><span class="line">          <span class="keyword">let</span> thisCount = counter++;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 打开始 log</span></span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'start processing'</span>, fullFilename, </span><br><span class="line">            <span class="string">'['</span>, thisCount, <span class="string">']'</span>);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 读取文件</span></span><br><span class="line">          fs.readFile(fullFilename, <span class="string">'utf-8'</span>, </span><br><span class="line">            <span class="function"><span class="keyword">function</span> (<span class="params">err, fileString</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">              <span class="built_in">console</span>.error(<span class="string">"error occurs when processing"</span>, </span><br><span class="line">                file, err);</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 做一些处理</span></span><br><span class="line">            fileString = fileString.replace(</span><br><span class="line">              /http:\/\<span class="comment">//g, 'https://');</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 写入文件</span></span><br><span class="line">            fs.writeFile(fullFilename, fileString, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">              <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="built_in">console</span>.error(<span class="string">"error occurs when processing"</span>, </span><br><span class="line">                  file, err);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="comment">// 打结束 log</span></span><br><span class="line">              <span class="built_in">console</span>.log(<span class="string">'finish processing'</span>, fullFilename, </span><br><span class="line">                <span class="string">'['</span>, thisCount, <span class="string">']'</span>);</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (stats.isDirectory()) &#123;</span><br><span class="line">          handleDir(fullFilename);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  handleDir(<span class="string">'/Users/zzz/hzzz.lengzzz.com/'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main();</span><br></pre></td></tr></table></figure>

<h3 id="公平起见-使用-goroutine-实现"><a href="#公平起见-使用-goroutine-实现" class="headerlink" title="公平起见 使用 goroutine 实现"></a>公平起见 使用 goroutine 实现</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"io/ioutil"</span></span><br><span class="line">  <span class="string">"log"</span></span><br><span class="line">  <span class="string">"path"</span></span><br><span class="line">  <span class="string">"path/filepath"</span></span><br><span class="line">  <span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> channelBuffer = <span class="number">50</span></span><br><span class="line"><span class="keyword">const</span> workerCount = <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> payload <span class="keyword">struct</span> &#123;</span><br><span class="line">  thisCount    <span class="keyword">int</span></span><br><span class="line">  fullFilename <span class="keyword">string</span></span><br><span class="line">  fileString   <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> producerToRead <span class="keyword">chan</span> *payload</span><br><span class="line"><span class="keyword">var</span> readToReplace <span class="keyword">chan</span> *payload</span><br><span class="line"><span class="keyword">var</span> replaceToWrite <span class="keyword">chan</span> *payload</span><br><span class="line"><span class="keyword">var</span> writeToComplete <span class="keyword">chan</span> *payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">  producerToRead = <span class="built_in">make</span>(<span class="keyword">chan</span> *payload, channelBuffer)</span><br><span class="line">  readToReplace = <span class="built_in">make</span>(<span class="keyword">chan</span> *payload, channelBuffer)</span><br><span class="line">  replaceToWrite = <span class="built_in">make</span>(<span class="keyword">chan</span> *payload, channelBuffer)</span><br><span class="line">  writeToComplete = <span class="built_in">make</span>(<span class="keyword">chan</span> *payload, channelBuffer)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reader</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> data := <span class="keyword">range</span> producerToRead &#123;</span><br><span class="line">    fileData, err := ioutil.ReadFile(data.fullFilename)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      log.Println(<span class="string">"error occurs when processing"</span>, </span><br><span class="line">        data.fullFilename, err)</span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line">    data.fileString = <span class="keyword">string</span>(fileData)</span><br><span class="line"></span><br><span class="line">    readToReplace &lt;- data</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">replacer</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> data := <span class="keyword">range</span> readToReplace &#123;</span><br><span class="line">    data.fileString = strings.Replace(data.fileString, </span><br><span class="line">      <span class="string">"http://"</span>, <span class="string">"https://"</span>, <span class="number">-1</span>)</span><br><span class="line">    replaceToWrite &lt;- data</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">writeer</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> data := <span class="keyword">range</span> replaceToWrite &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err := ioutil.WriteFile(data.fullFilename, </span><br><span class="line">      []<span class="keyword">byte</span>(data.fileString), <span class="number">0644</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      log.Println(<span class="string">"error occurs when processing"</span>, </span><br><span class="line">        data.fullFilename, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    writeToComplete &lt;- data</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">complete</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> data := <span class="keyword">range</span> writeToComplete &#123;</span><br><span class="line">    log.Println(<span class="string">"finish processing"</span>, data.fullFilename, </span><br><span class="line">      <span class="string">"["</span>, data.thisCount, <span class="string">"]"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> counter = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">producer</span><span class="params">(dir <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">const</span> extname = <span class="string">".html"</span></span><br><span class="line"></span><br><span class="line">  files, err := ioutil.ReadDir(dir)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Println(<span class="string">"error occurs when readDir"</span>, dir, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> _, file := <span class="keyword">range</span> files &#123;</span><br><span class="line">    fullFilename := path.Join(dir, file.Name())</span><br><span class="line">    <span class="keyword">if</span> !file.IsDir() &amp;&amp; filepath.Ext(file.Name()) == extname &#123;</span><br><span class="line">      counter++</span><br><span class="line">      thisCount := counter</span><br><span class="line">      log.Println(<span class="string">"start processing"</span>, fullFilename, </span><br><span class="line">        <span class="string">"["</span>, thisCount, <span class="string">"]"</span>)</span><br><span class="line"></span><br><span class="line">      producerToRead &lt;- &amp;payload&#123;</span><br><span class="line">        thisCount,</span><br><span class="line">        fullFilename,</span><br><span class="line">        <span class="string">""</span>,</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> file.IsDir() &#123;</span><br><span class="line">      producer(fullFilename)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 搞四个 worker</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startWorker</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; workerCount; i++ &#123;</span><br><span class="line">    <span class="keyword">go</span> reader()</span><br><span class="line">    <span class="keyword">go</span> replacer()</span><br><span class="line">    <span class="keyword">go</span> writeer()</span><br><span class="line">    <span class="keyword">go</span> complete()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  startWorker()</span><br><span class="line">  producer(<span class="string">"/Users/zzz/hzzz.lengzzz.com/"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Title: golang worker 实现</span><br><span class="line"></span><br><span class="line">Note over producer: 生成文件名</span><br><span class="line">producer-&gt;reader: channel</span><br><span class="line">Note over reader: 读文件</span><br><span class="line">reader-&gt;replacer: channel</span><br><span class="line">Note over replacer: 修改文件</span><br><span class="line">replacer-&gt;writer: channel</span><br><span class="line">Note over writer: 写文件</span><br><span class="line">writer-&gt;complete: channel</span><br><span class="line">Note over complete: 打 log</span><br><span class="line"></span><br><span class="line">Note over producer,complete: 并发</span><br></pre></td></tr></table></figure>

<h3 id="性能比较"><a href="#性能比较" class="headerlink" title="性能比较"></a>性能比较</h3><p>分别看一下两个程序打出的 log ，来分析一下哪个程序会运行的更快。</p>
<h4 id="golang-的-log"><a href="#golang-的-log" class="headerlink" title="golang 的 log"></a>golang 的 log</h4><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">start processing /<span class="number">1001</span>/index.html [ <span class="number">1</span> ]</span><br><span class="line">finish processing /<span class="number">1001</span>/index.html [ <span class="number">1</span> ]</span><br><span class="line">start processing /<span class="number">1001</span>/trackback/index.html [ <span class="number">2</span> ]</span><br><span class="line">finish processing /<span class="number">1001</span>/trackback/index.html [ <span class="number">2</span> ]</span><br><span class="line">start processing /<span class="number">1006</span>/index.html [ <span class="number">3</span> ]</span><br><span class="line">finish processing /<span class="number">1006</span>/index.html [ <span class="number">3</span> ]</span><br><span class="line">start processing /<span class="number">1006</span>/trackback/index.html [ <span class="number">4</span> ]</span><br><span class="line">finish processing /<span class="number">1006</span>/trackback/index.html [ <span class="number">4</span> ]</span><br><span class="line">start processing /<span class="number">101</span>/index.html [ <span class="number">5</span> ]</span><br><span class="line">finish processing /<span class="number">101</span>/index.html [ <span class="number">5</span> ]</span><br><span class="line">start processing /<span class="number">101</span>/trackback/index.html [ <span class="number">6</span> ]</span><br><span class="line">finish processing /<span class="number">101</span>/trackback/index.html [ <span class="number">6</span> ]</span><br><span class="line">start processing /<span class="number">1010</span>/index.html [ <span class="number">7</span> ]</span><br><span class="line">finish processing /<span class="number">1010</span>/index.html [ <span class="number">7</span> ]</span><br><span class="line">start processing /<span class="number">1010</span>/trackback/index.html [ <span class="number">8</span> ]</span><br><span class="line">finish processing /<span class="number">1010</span>/trackback/index.html [ <span class="number">8</span> ]</span><br><span class="line">start processing /<span class="number">1027</span>/index.html [ <span class="number">9</span> ]</span><br><span class="line">finish processing /<span class="number">1027</span>/index.html [ <span class="number">9</span> ]</span><br><span class="line">start processing /<span class="number">1027</span>/trackback/index.html [ <span class="number">10</span> ]</span><br><span class="line">finish processing /<span class="number">1027</span>/trackback/index.html [ <span class="number">10</span> ]</span><br></pre></td></tr></table></figure>

<p>特点是挨个抓取，第一个没有抓完不开始抓第二个。</p>
<h4 id="NodeJS-的-log"><a href="#NodeJS-的-log" class="headerlink" title="NodeJS 的 log"></a>NodeJS 的 log</h4><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">start processing /index.html [ <span class="number">0</span> ]</span><br><span class="line">start processing /blog/index.html [ <span class="number">1</span> ]</span><br><span class="line">start processing /blog/wp-login.html [ <span class="number">2</span> ]</span><br><span class="line">start processing /blog/<span class="number">1001</span>/index.html [ <span class="number">3</span> ]</span><br><span class="line">start processing /blog/<span class="number">1006</span>/index.html [ <span class="number">4</span> ]</span><br><span class="line">start processing /blog/<span class="number">101</span>/index.html [ <span class="number">5</span> ]</span><br><span class="line"></span><br><span class="line">... 省略</span><br><span class="line"></span><br><span class="line">start processing /blog/page/<span class="number">9</span>/index.html [ <span class="number">736</span> ]</span><br><span class="line">finish processing /index.html [ <span class="number">0</span> ]</span><br><span class="line">start processing /blog/date/<span class="number">2013</span>/<span class="number">08</span>/index.html [ <span class="number">737</span> ]</span><br></pre></td></tr></table></figure>

<p>特点是同时抓取网页，谁先抓完先处理谁，谁先处理完谁就保存。不需要等待。</p>
<h4 id="golang-第二版的-log"><a href="#golang-第二版的-log" class="headerlink" title="golang 第二版的 log"></a>golang 第二版的 log</h4><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">start processing /blog/<span class="number">1001</span>/index.html [ <span class="number">1</span> ]</span><br><span class="line">start processing /blog/<span class="number">1001</span>/trackback/index.html [ <span class="number">2</span> ]</span><br><span class="line">start processing /blog/<span class="number">1006</span>/index.html [ <span class="number">3</span> ]</span><br><span class="line">start processing /blog/<span class="number">1006</span>/trackback/index.html [ <span class="number">4</span> ]</span><br><span class="line">start processing /blog/<span class="number">101</span>/index.html [ <span class="number">5</span> ]</span><br><span class="line">start processing /blog/<span class="number">101</span>/trackback/index.html [ <span class="number">6</span> ]</span><br><span class="line">start processing /blog/<span class="number">1010</span>/index.html [ <span class="number">7</span> ]</span><br><span class="line">start processing /blog/<span class="number">1010</span>/trackback/index.html [ <span class="number">8</span> ]</span><br><span class="line">start processing /blog/<span class="number">1027</span>/index.html [ <span class="number">9</span> ]</span><br><span class="line">start processing /blog/<span class="number">1027</span>/trackback/index.html [ <span class="number">10</span> ]</span><br><span class="line">start processing /blog/<span class="number">1030</span>/index.html [ <span class="number">11</span> ]</span><br><span class="line">start processing /blog/<span class="number">1030</span>/trackback/index.html [ <span class="number">12</span> ]</span><br><span class="line">start processing /blog/<span class="number">1038</span>/index.html [ <span class="number">13</span> ]</span><br><span class="line">start processing /blog/<span class="number">1038</span>/trackback/index.html [ <span class="number">14</span> ]</span><br><span class="line">finish processing /blog/<span class="number">101</span>/trackback/index.html [ <span class="number">6</span> ]</span><br><span class="line">start processing /blog/<span class="number">1040</span>/index.html [ <span class="number">15</span> ]</span><br></pre></td></tr></table></figure>

<h4 id="KFC-和-麻辣烫"><a href="#KFC-和-麻辣烫" class="headerlink" title="KFC 和 麻辣烫"></a>KFC 和 麻辣烫</h4><p>可以对比一下 KFC 和 麻辣烫 店的点餐方式，和上面两个程序有异曲同工之妙。</p>
<ul>
<li>KFC：大家排队，前面的餐没全部做出来前不服务下一个客户</li>
<li>麻辣烫：大家分别点餐，然后拿个号码，叫号取餐</li>
</ul>
<p>谁更快显而易见。在 KFC 里最怕前面点个全家桶，好不容易排到第一个了，结果还不如旁边队列里最后的取餐快。</p>
<p>所以可见，NodeJS 只需要使用一般的写法就能自动获得 <strong>性能加成</strong> 还是很有吸引力的。</p>
<h3 id="可读性比较"><a href="#可读性比较" class="headerlink" title="可读性比较"></a>可读性比较</h3><p>golang 的代码是按照先后顺序很直观的顺下来的，可以看一下几个注释，都在同一个缩进级别。</p>
<p>而 NodeJS 使用了大量回调函数，本身串行的逻辑看起来却像是内嵌的感觉，从代码的缩进就能明显的看出来。大家亲切的成这种代码风格叫做 <strong>冲击波</strong>。</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 冲击波</span></span><br><span class="line">&#123;</span><br><span class="line">  &#123;</span><br><span class="line">    &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        &#123;</span><br><span class="line">          &#123;</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">// ============ &gt;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>golang 使用 goroutine 重新实现之后性能得到了提升，但是可读性也是降低了一些。如果逻辑比较复杂则 channel 不很好设计。</p>
<p>除此之外 NodeJS 的写法还有几个坑：</p>
<ul>
<li>对循环支持的不好，循环内部的回调函数访问同一个闭包变量（ES2015 的 <code>let</code> 可解决这个问题） </li>
<li>错误处理不友好，只能（ almostly ）直接跳出事务，没法爽快 try catch （例子：超时重传）</li>
</ul>
<h2 id="同步的代码-异步的事情"><a href="#同步的代码-异步的事情" class="headerlink" title="同步的代码 异步的事情"></a>同步的代码 异步的事情</h2><p>那么有没有一种方法，能同时具备两种写法的优点呢？答案就是前端终极武器 <code>await &amp; async</code> 。</p>
<p>首先来看一下 <code>await</code> 的使用方法，我给出一个同样功能（爬虫）的示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; readDir, stat, readFile, writeFile &#125; <span class="keyword">from</span> <span class="string">'./api_promise'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> counter = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> extname = <span class="string">'.html'</span>;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">handleDir</span>(<span class="params">dir</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 读取文件夹列表</span></span><br><span class="line">    <span class="keyword">let</span> files = <span class="keyword">await</span> readDir(dir);</span><br><span class="line">    <span class="comment">// iterate 列表</span></span><br><span class="line">    files.map(<span class="keyword">async</span> file =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> fullFilename = path.join(dir, file);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 检查文件类型</span></span><br><span class="line">        <span class="keyword">let</span> stats = <span class="keyword">await</span> stat(fullFilename);</span><br><span class="line">        <span class="keyword">if</span> (stats.isFile() &amp;&amp; path.extname(file) == extname) &#123;</span><br><span class="line">          <span class="keyword">let</span> thisCount = counter++;</span><br><span class="line">          <span class="comment">// 打开始 log</span></span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'start processing'</span>, fullFilename, </span><br><span class="line">            <span class="string">'['</span>, thisCount, <span class="string">']'</span>);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 读文件</span></span><br><span class="line">          <span class="keyword">let</span> fileString = <span class="keyword">await</span> readFile(fullFilename, <span class="string">'utf-8'</span>);</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 改文件</span></span><br><span class="line">          fileString = fileString.replace(<span class="regexp">/http:\/\//g</span>, <span class="string">'https://'</span>);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 写文件</span></span><br><span class="line">          <span class="keyword">await</span> writeFile(fullFilename, fileString);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 打结束 log</span></span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'finish processing'</span>, fullFilename, </span><br><span class="line">            <span class="string">'['</span>, thisCount, <span class="string">']'</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (stats.isDirectory()) &#123;</span><br><span class="line">          handleDir(fullFilename);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">"error occurs when processing"</span>, file, err);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">"error occurs when readDir"</span>, dir, err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  handleDir(<span class="string">'/Users/zzz/hzzz.lengzzz.com/'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main();</span><br></pre></td></tr></table></figure>

<p>代码清晰了不少，但是性能还和之前一样，异步的读文件，异步的写文件。另外我还加入了 <code>try catch</code> ，来演示 await 对 try catch 的支持。</p>
<p>此外，还需要做的事情是对原生的 API 进行一下包装。使之返回一个 <code>Promise</code> 以支持 await。</p>
<p>如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">"fs"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">readDir</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    fs.readdir(path, <span class="function"><span class="keyword">function</span> (<span class="params">err, files</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        reject(err);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      resolve(files);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里只举例一个了，这个文件 wrap 了四个 NodeJS API ，都是使用相同的方式包装的。</p>
<h2 id="实现篇"><a href="#实现篇" class="headerlink" title="实现篇"></a>实现篇</h2><p>其实，await 只是一个语法糖。下面，分析一下这颗糖底层是怎么实现的。</p>
<h3 id="Iterator"><a href="#Iterator" class="headerlink" title="Iterator"></a>Iterator</h3><p>要说 await 不得不先温习一些前置知识，比如 iterator 和协程。</p>
<p>在大部分语言中，要实现一个类型可以被 iterate （既让一个类型 iterable）一般需要实现一个叫 <code>Iterable</code> 的 interface。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">List</span> <span class="keyword">implements</span> <span class="title">Iterable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个 Iterable 有方法能返回一个 <code>Iterator</code> 循环调用 Iterator 的方法 <code>next()</code> 可以得到下一个元素，调用 <code>hasNext()</code> 可以判断是否结束。</p>
<p>所以 Iterator 可以这样实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">List</span> <span class="keyword">implements</span> <span class="title">Iterable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// nested class</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ListIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> max = <span class="number">10</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> i++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> i &gt; max;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ListIterator();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，就可以 iterate 一个 List 了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List list = <span class="keyword">new</span> List();</span><br><span class="line"><span class="keyword">for</span> (Object i : list) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 javascript 中也不例外，这样实现一个 Iterable ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> iterable = &#123;</span><br><span class="line">    [<span class="built_in">Symbol</span>.iterator]: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> iterator = &#123;</span><br><span class="line">            next: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> iteratorResult = &#123;</span><br><span class="line">                    done: i &gt; <span class="number">10</span>,</span><br><span class="line">                    value: i++</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">return</span> iteratorResult;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> iterator;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> item <span class="keyword">of</span> iterable) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(item);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h3><p>协程是一种抽象方式，可以让一个函数中途暂停返回一些东西，然后过一段时间后再继续执行。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">routine</span><span class="params">()</span></span> </span><br><span class="line">    <span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line">    coroutine.<span class="built_in">yield</span>(i)</span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line">    coroutine.<span class="built_in">yield</span>(i)</span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line">    coroutine.<span class="built_in">yield</span>(i)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>调用三次 routine 后分别能得到 <code>1 2 3</code> 。原因是协程执行了一半被暂停后会保存下它自己的上下文，以便下次 resume后数据还在。</p>
<h3 id="Generator"><a href="#Generator" class="headerlink" title="Generator"></a>Generator</h3><p>Generator 相当于 javascript 中的协程，在一个 Generator 函数中使用 <code>yield</code> 关键字，可以暂停函数执行，返回一个结果。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 符号 * 代表 generator</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">routine</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">yield</span> i++;</span><br><span class="line">    <span class="keyword">yield</span> i++;</span><br><span class="line">    <span class="keyword">yield</span> i++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码和上面的 lua 代码等价。</p>
<p>使用 generator 函数可以方便的实现一个 iterator：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">iterable = &#123;</span><br><span class="line">    [<span class="built_in">Symbol</span>.iterator]: <span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">            <span class="keyword">yield</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> item <span class="keyword">of</span> iterable) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(item);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和上面的 iterable 代码等价，但是可以使用 for 循环了，是不是简洁多了？</p>
<h3 id="await-amp-async"><a href="#await-amp-async" class="headerlink" title="await &amp; async"></a>await &amp; async</h3><p>可能大家已经想到了，async 函数就是被翻译成了 generator 函数，ya。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getArticle</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> test = $(<span class="string">'.test'</span>);</span><br><span class="line">    <span class="keyword">var</span> comments = <span class="keyword">await</span> getComments();</span><br><span class="line">    test.append(<span class="string">'&lt;p&gt;'</span> + <span class="built_in">JSON</span>.stringify(comments) + <span class="string">'&lt;/p&gt;'</span>);</span><br><span class="line">    <span class="keyword">var</span> posts = <span class="keyword">await</span> getPosts();</span><br><span class="line">    test.append(<span class="string">'&lt;p&gt;'</span> + <span class="built_in">JSON</span>.stringify(posts) + <span class="string">'&lt;/p&gt;'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 翻译成=====&gt; </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">getArticle</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> test = $(<span class="string">'.test'</span>);</span><br><span class="line">    <span class="keyword">var</span> comments = <span class="keyword">yield</span> getComments();</span><br><span class="line">    test.append(<span class="string">'&lt;p&gt;'</span> + <span class="built_in">JSON</span>.stringify(comments) + <span class="string">'&lt;/p&gt;'</span>);</span><br><span class="line">    <span class="keyword">var</span> posts = <span class="keyword">yield</span> getPosts();</span><br><span class="line">    test.append(<span class="string">'&lt;p&gt;'</span> + <span class="built_in">JSON</span>.stringify(posts) + <span class="string">'&lt;/p&gt;'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当调用一个 async 函数时，实际上是这样做的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">getArticle();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 翻译成&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;</span><br><span class="line"></span><br><span class="line">runner(getArticle);</span><br><span class="line"></span><br><span class="line">function runner(getIterator) &#123;</span><br><span class="line">    var iterator &#x3D; getIterator();</span><br><span class="line">    function next(data) &#123;</span><br><span class="line">        var result &#x3D; iterator.next(data);</span><br><span class="line">        if (result.done)&#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        var promise &#x3D; result.value;</span><br><span class="line">        promise.then(function (data) &#123;</span><br><span class="line">            next(data);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    next();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="拓展篇"><a href="#拓展篇" class="headerlink" title="拓展篇"></a>拓展篇</h2><h3 id="1-在-NodeJS-中避免大规模计算"><a href="#1-在-NodeJS-中避免大规模计算" class="headerlink" title="1. 在 NodeJS 中避免大规模计算"></a>1. 在 NodeJS 中避免大规模计算</h3><p>Javascript 只有一根线程，如果用 for 循环来计算 10000 个数字的和，整个 vm 都非卡死不行。</p>
<p>以前大家都用 <code>setTimeout / setInterval</code> 来把运算拆开来做：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> output = $(<span class="string">'.power'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> i = <span class="number">0</span>, end = <span class="number">10000</span>;</span><br><span class="line">	<span class="keyword">var</span> cancel = setInterval(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">let</span> p = i * i;</span><br><span class="line">		output.append(<span class="string">`&lt;p&gt;<span class="subst">$&#123;p&#125;</span>&lt;/p&gt;`</span>);</span><br><span class="line">		<span class="keyword">if</span> (++i &gt;= end) &#123;</span><br><span class="line">			clearInterval(cancel);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在可以用 await 了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPower</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">		setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">			resolve(x * x);</span><br><span class="line">		&#125;, <span class="number">0</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> output = $(<span class="string">'.power'</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">		<span class="keyword">let</span> p = <span class="keyword">await</span> getPower(i);</span><br><span class="line">		output.append(<span class="string">`&lt;p&gt;<span class="subst">$&#123;p&#125;</span>&lt;/p&gt;`</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这两种都不会卡 vm 但是第二种显然直观一些。</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p><a href="https://github.com/zwh8800/analyse-await" target="_blank" rel="noopener">https://github.com/zwh8800/analyse-await</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/es2015/">es2015</a><a href="/tags/javascript/">javascript</a><a href="/tags/await/">await</a><a href="/tags/stage3/">stage3</a>
    </span>
    

    </div>

    
  </div>
</article>

  



	<section id="comment" class="comment">
	  <div id="disqus_thread">
	  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
	  </div>
	</section>

	<script type="text/javascript">
	var disqus_shortname = 'lengzzz';
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	</script>




    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2021 wastecat
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-47471611-1', 'auto');
    ga('send', 'pageview');

</script>

  </div>
</div>
</body>
</html>