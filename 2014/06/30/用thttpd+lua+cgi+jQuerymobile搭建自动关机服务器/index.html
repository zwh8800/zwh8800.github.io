<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>用 thttpd+lua+cgi+jQuery mobile 搭建自动关机服务器 | wastecat的博客</title>

  
  <meta name="author" content="wastecat">
  

  
  <meta name="description" content="最近猎豹 wifi 共享精灵推出了一个 wifi 控制关机的功能. 我因为没有笔记本一直都用台式机 + linux nat + 无线 ap 来实现 wifi 共享 (见上次用虚拟机建立 NAT 曲线共享上网的经历忘了记录了). 所以看到这个功能之后一直眼红的不行, 在床上看视频到两三点再下去关电脑实">
  

  
  
  <meta name="keywords" content="服务器">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="用 thttpd+lua+cgi+jQuery mobile 搭建自动关机服务器"/>

  <meta property="og:site_name" content="wastecat的博客"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="wastecat的博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 4.2.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">wastecat的博客</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/2020/04/29/hello-world/">关于</a></li>
      
        <li><a href="/atom.xml">订阅</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>用 thttpd+lua+cgi+jQuery mobile 搭建自动关机服务器</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2014/06/30/用thttpd+lua+cgi+jQuerymobile搭建自动关机服务器/" rel="bookmark">
        <time class="entry-date published" datetime="2014-06-30T00:00:00.000Z">
          2014-06-30
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>最近猎豹 wifi 共享精灵推出了一个 wifi 控制关机的功能. 我因为没有笔记本一直都用台式机 + linux nat + 无线 ap 来实现 wifi 共享 (见上次用虚拟机建立 NAT 曲线共享上网的经历忘了记录了). 所以看到这个功能之后一直眼红的不行, 在床上看视频到两三点再下去关电脑实在是破坏幸福感的事情. 所以嘛, 就又到了自己造轮子的时间.</p>
<p><a href="/notename/" title="archive 20140630"></a></p>
<p>首先分析一下需求, 很简单就是在手机上打开一个网页可以远程控制我的台式机关机.</p>
<p>所以必须要有一个 web 服务器, 另外一门 web 脚本语言也是必不可少的, 而且前端网页应该尽量漂亮, 并且适配手机.</p>
<p>首先 web 服务器应当尽量小巧, 一开始我用 shttpd 来做, 用了一天之后发现它对 http 验证支持的不很好. 所以便放弃他选择 thttpd 了. thttpd 也很小巧而且功能更多, 并且自称性能上不弱于 Apache.</p>
<p>然后脚本语言, 脚本语言的话我只会 lua 和 javascript, 如果用 javascript 的话需要用到 nodejs, 可是我有点不习惯 nodejs 的异步模型和一层一层的函数嵌套. 所以还是选 lua 吧. 而且 thttpd 支持 cgi, 可以和 lua 很好的适配</p>
<p>ok, 下面开始搭建环境. 因为对性能的要求不高, 所以决定在 Cygwin 下运行. 下载编译 thttpd, 直接 wget-&gt;./configure –prefix/usr-&gt;make-&gt;make install 就 ok 了.</p>
<p>中间可能在编译 htpasswd.c 文件时提示 getline 重定义. 直接把 htpasswd.c 文件里的所有 getline 改名成_getline 即可.</p>
<p>安装的时候会提示没有 / usr/man/man1 文件夹, 直接 mkdir /usr/man/man1 就 ok</p>
<p>thttpd 支持命令行启动同时也支持配置文件. 具体可以 man thttpd 来查看. 在源码包里的./contrib/redhat-rpm 文件夹有一个例子的配置文件. 我们把它改一下放到用户目录里:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This section overrides defaults</span></span><br><span class="line"><span class="attribute">dir</span>=/home/Administrator/webroot</span><br><span class="line"><span class="comment">#chroot</span></span><br><span class="line"><span class="attribute">user</span>=Administrator#<span class="built_in"> default </span>= nobody</span><br><span class="line"><span class="attribute">logfile</span>=/var/log/thttpd.log</span><br><span class="line"><span class="attribute">pidfile</span>=/var/run/thttpd.pid</span><br><span class="line"><span class="comment"># This section _documents_ defaults in effect</span></span><br><span class="line"><span class="comment"># port=80</span></span><br><span class="line"><span class="comment"># nosymlink# default = !chroot</span></span><br><span class="line"><span class="comment"># novhost</span></span><br><span class="line"><span class="attribute">cgipat</span>=/*.cgi</span><br><span class="line"><span class="comment"># nothrottles</span></span><br><span class="line"><span class="comment"># host=0.0.0.0</span></span><br><span class="line"><span class="comment"># charset=iso-8859-1</span></span><br></pre></td></tr></table></figure>

<p>然后就是安装 lua 了, Cygwin 源里直接就有, 装上即可.</p>
<p>在用户目录里建立一个 webroot 文件夹, 网站放这里.</p>
<p>建立两个文件, 一个叫 index.cgi, 一个叫 shutdown.cgi 内容如下:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">#!/bin/lua</span></span><br><span class="line"><span class="xml"> </span></span><br><span class="line"><span class="xml">local Z_SHUTDOWN_FILE = "/tmp/zshutdown"</span></span><br><span class="line"><span class="xml"> </span></span><br><span class="line"><span class="xml">print("Content-type: text/html")</span></span><br><span class="line"><span class="xml">print()</span></span><br><span class="line"><span class="xml"> </span></span><br><span class="line"><span class="xml">local is_shutting_down</span></span><br><span class="line"><span class="xml">local time_to_shutdown</span></span><br><span class="line"><span class="xml">local file = io.open(Z_SHUTDOWN_FILE, "r")	--read模式, 可查看文件是否存在</span></span><br><span class="line"><span class="xml">if file == nil then</span></span><br><span class="line"><span class="xml">	is_shutting_down = false</span></span><br><span class="line"><span class="xml"> </span></span><br><span class="line"><span class="xml">else</span></span><br><span class="line"><span class="xml">	is_shutting_down = true</span></span><br><span class="line"><span class="xml">	local t1 = assert(file:read("*n"))</span></span><br><span class="line"><span class="xml">	time_to_shutdown = 30 - os.difftime(os.time(), t1)</span></span><br><span class="line"><span class="xml">	if time_to_shutdown <span class="tag">&lt; <span class="attr">0</span> <span class="attr">then</span></span></span></span><br><span class="line"><span class="xml">		is_shutting_down = false</span></span><br><span class="line"><span class="xml">		os.remove(Z_SHUTDOWN_FILE)</span></span><br><span class="line"><span class="xml">	end</span></span><br><span class="line"><span class="xml">end</span></span><br><span class="line"></span><br><span class="line"><span class="xml">print[=[</span></span><br><span class="line"><span class="xml"><span class="meta">&lt;!Doctype <span class="meta-keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">https://www.w3.org/1999/xhtml</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">title</span>&gt;</span>zzZ的自动关机<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml"> </span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"mobile-agent"</span> <span class="attr">content</span>=<span class="string">"format=html5;"</span>&gt;</span></span></span><br><span class="line"><span class="xml"> </span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://code.jquery.com/jquery-1.8.3.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml"> </span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"> </span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">data-role</span>=<span class="string">"page"</span> <span class="attr">id</span>=<span class="string">"main"</span>&gt;</span></span></span><br><span class="line"><span class="xml"> </span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">data-role</span>=<span class="string">"header"</span> <span class="attr">data-position</span>=<span class="string">"fixed"</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">h1</span>&gt;</span>zzZ的自动关机<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"> </span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"text-align:center;"</span> <span class="attr">data-role</span>=<span class="string">"content"</span>&gt;</span></span></span><br><span class="line"><span class="xml"> </span></span><br><span class="line"><span class="xml">]=]</span></span><br><span class="line"><span class="xml">	if is_shutting_down then</span></span><br><span class="line"><span class="xml">	print[=[</span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">p</span>&gt;</span>您的电脑将在<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"time"</span> <span class="attr">style</span>=<span class="string">"color:red"</span>&gt;</span>]=] print(time_to_shutdown); print[=[<span class="tag">&lt;/<span class="name">span</span>&gt;</span>秒后自动关机<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml">			var t = ]=] print(time_to_shutdown); print[=[;</span></span><br><span class="line"><span class="xml">			function decrease()</span></span><br><span class="line"><span class="xml">			&#123; if (t &gt; 0)$("#time").text(--t); &#125;</span></span><br><span class="line"><span class="xml">			setInterval("decrease()", 1000);</span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">p</span>&gt;</span>按动按钮来取消关机：<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"shutdown.cgi"</span> <span class="attr">data-rel</span>=<span class="string">"dialog"</span> <span class="attr">data-role</span>=<span class="string">"button"</span> <span class="attr">data-inline</span>=<span class="string">"true"</span> <span class="attr">data-icon</span>=<span class="string">"info"</span>&gt;</span>取消关机<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">	]=]</span></span><br><span class="line"><span class="xml">	else</span></span><br><span class="line"><span class="xml">	print[=[</span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">p</span>&gt;</span>按动按钮来进行关机：<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#shutdown_confirm"</span> <span class="attr">data-rel</span>=<span class="string">"dialog"</span> <span class="attr">data-role</span>=<span class="string">"button"</span> <span class="attr">data-inline</span>=<span class="string">"true"</span> <span class="attr">data-icon</span>=<span class="string">"info"</span>&gt;</span>关机<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">	]=]</span></span><br><span class="line"><span class="xml">	end</span></span><br><span class="line"><span class="xml">print[=[</span></span><br><span class="line"><span class="xml"> </span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"> </span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">data-role</span>=<span class="string">"footer"</span> <span class="attr">data-position</span>=<span class="string">"fixed"</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">h1</span>&gt;</span>Powered by zzZ<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"> </span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"> </span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">data-role</span>=<span class="string">"page"</span> <span class="attr">id</span>=<span class="string">"shutdown_confirm"</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">data-role</span>=<span class="string">"header"</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">h1</span>&gt;</span>真的要进行关机?<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"> </span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">data-role</span>=<span class="string">"content"</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">center</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"shutdown.cgi"</span> <span class="attr">data-rel</span>=<span class="string">"dialog"</span> <span class="attr">data-role</span>=<span class="string">"button"</span> <span class="attr">data-inline</span>=<span class="string">"true"</span> <span class="attr">data-icon</span>=<span class="string">"info"</span>&gt;</span>确认<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#main"</span> <span class="attr">data-role</span>=<span class="string">"button"</span> <span class="attr">data-inline</span>=<span class="string">"true"</span> <span class="attr">data-icon</span>=<span class="string">"delete"</span>&gt;</span>取消<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">center</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"> </span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">data-role</span>=<span class="string">"footer"</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">h1</span>&gt;</span>Powered by zzZ<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"> </span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"> </span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml">]=]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/lua</span><br><span class="line"> </span><br><span class="line">local Z_SHUTDOWN_FILE = "/tmp/zshutdown"</span><br><span class="line"> </span><br><span class="line">print("Content-type: text/html")</span><br><span class="line">print()</span><br><span class="line"> </span><br><span class="line">local is_shutting_down</span><br><span class="line">local file = io.open(Z_SHUTDOWN_FILE, "r")	--read模式, 可查看文件是否存在</span><br><span class="line">if file == nil then</span><br><span class="line">	is_shutting_down = false</span><br><span class="line">	file = io.open(Z_SHUTDOWN_FILE, "w")	--write模式, 打开文件并写入</span><br><span class="line">	file:write(os.time())</span><br><span class="line">	file:close()</span><br><span class="line"> </span><br><span class="line">	os.execute('shutdown -s 30')</span><br><span class="line">else</span><br><span class="line">	is_shutting_down = true</span><br><span class="line">	os.remove(Z_SHUTDOWN_FILE)</span><br><span class="line"> </span><br><span class="line">	os.execute('shutdown -a')</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">print[=[</span><br><span class="line"><span class="meta">&lt;!Doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">https://www.w3.org/1999/xhtml</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>关机命令已接受<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"mobile-agent"</span> <span class="attr">content</span>=<span class="string">"format=html5;"</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://code.jquery.com/jquery-1.8.3.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">data-role</span>=<span class="string">"page"</span> <span class="attr">id</span>=<span class="string">"main"</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">data-role</span>=<span class="string">"header"</span> <span class="attr">data-position</span>=<span class="string">"fixed"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><br><span class="line">]=]</span><br><span class="line"> </span><br><span class="line">if is_shutting_down then</span><br><span class="line">	print "关机已取消"</span><br><span class="line">else</span><br><span class="line">	print "关机命令已接受"</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">print[=[</span><br><span class="line">		<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">data-role</span>=<span class="string">"content"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">center</span>&gt;</span></span><br><span class="line">]=]</span><br><span class="line"> </span><br><span class="line">if is_shutting_down then</span><br><span class="line">print[=[</span><br><span class="line">		<span class="tag">&lt;<span class="name">p</span>&gt;</span>关机命令已取消<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:location.reload(true)"</span> <span class="attr">data-role</span>=<span class="string">"button"</span> <span class="attr">data-inline</span>=<span class="string">"true"</span> <span class="attr">data-icon</span>=<span class="string">"info"</span>&gt;</span>返回<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">]=]</span><br><span class="line">else</span><br><span class="line">print[=[</span><br><span class="line">		<span class="tag">&lt;<span class="name">p</span>&gt;</span>您的电脑将在<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"time"</span> <span class="attr">style</span>=<span class="string">"color:red"</span>&gt;</span>30<span class="tag">&lt;/<span class="name">span</span>&gt;</span>秒后自动关机<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">			<span class="keyword">var</span> t = <span class="number">30</span>;</span></span><br><span class="line"><span class="actionscript">			<span class="function"><span class="keyword">function</span> <span class="title">decrease</span><span class="params">()</span></span></span></span><br><span class="line"><span class="javascript">			&#123; <span class="keyword">if</span> (t &gt; <span class="number">0</span>)$(<span class="string">"#time"</span>).text(--t); &#125;</span></span><br><span class="line"><span class="actionscript">			setInterval(<span class="string">"decrease()"</span>, <span class="number">1000</span>);</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:location.reload(true)"</span> <span class="attr">data-role</span>=<span class="string">"button"</span> <span class="attr">data-inline</span>=<span class="string">"true"</span> <span class="attr">data-icon</span>=<span class="string">"info"</span>&gt;</span>返回<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">]=]</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">print[=[</span><br><span class="line">	<span class="tag">&lt;/<span class="name">center</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">data-role</span>=<span class="string">"footer"</span> <span class="attr">data-position</span>=<span class="string">"fixed"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">h1</span>&gt;</span>Powered by zzZ<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">]=]</span><br></pre></td></tr></table></figure>

<p>ok 了, 效果如图:<br><img src="/images/dc6301a96e391057fb0cfb8bcd3fc74a.png" alt="image_1bl0277mi94vhuh2v11d3gar49.png-219.7kB"><br><img src="/images/4789e1c26caf08227eaa3c091e0bb62e.png" alt="image_1bl028649hrj10b9p66155e14jtm.png-153.8kB"><br><img src="/images/f7b3757809fd7dba1d21960dbd536c63.png" alt="image_1bl028n31qgj1ikq13e81ktcqam13.png-130kB"><br><img src="/images/06fb4e81672adaec9ccc9460df3dd743.png" alt="image_1bl029cp41lakb6l1f1m1tfmrf91g.png-136.7kB"><br><img src="/images/c33dce5afd2795a43a0449814d7bcc60.png" alt="image_1bl02a0ek97d1m54foe9suips1t.png-177.8kB"><br><img src="/images/d30655870f70159bab5687b887a3dc3d.png" alt="image_1bl02ajhhg2v1vqc1kmbmrm1ilh2a.png-124.4kB"></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/服务器/">服务器</a>
    </span>
    

    </div>

    
  </div>
</article>

  



	<section id="comment" class="comment">
	  <div id="disqus_thread">
	  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
	  </div>
	</section>

	<script type="text/javascript">
	var disqus_shortname = 'lengzzz';
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	</script>




    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2020 wastecat
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-47471611-1', 'auto');
    ga('send', 'pageview');

</script>

  </div>
</div>
</body>
</html>